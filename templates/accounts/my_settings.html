{% extends 'base.html' %}

{% block title %}ê³„ì • ì„¤ì • - í”¼í¬ë¯¼ ë‹¤ì´ì–´ë¦¬{% endblock %}

{% block content %}
<div class="container">
    <div class="settings-page">
        <div class="page-header">
            <a href="{% url 'accounts:my_page' %}" class="back-link">â† ë§ˆì´í˜ì´ì§€</a>
            <h1 class="page-title">âš™ï¸ ê³„ì • ì„¤ì •</h1>
        </div>

        <form method="post" enctype="multipart/form-data" class="settings-form card">
            {% csrf_token %}

            <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
            <div class="form-group">
                <label class="form-label">í”„ë¡œí•„ ì´ë¯¸ì§€</label>
                <div class="avatar-upload">
                    <div class="current-avatar">
                        {% if user.profile_image %}
                        <img src="{{ user.profile_image.url }}" alt="{{ user.nickname }}">
                        {% else %}
                        <div class="avatar-placeholder">{{ user.nickname|slice:":1" }}</div>
                        {% endif %}
                    </div>
                    <input type="file" name="profile_image" accept="image/*" class="form-control">
                </div>
            </div>

            <!-- ë‹‰ë„¤ì„ -->
            <div class="form-group">
                <label class="form-label">ë‹‰ë„¤ì„</label>
                <input type="text" name="nickname" value="{{ user.nickname }}" class="form-control" maxlength="30"
                    required>
            </div>

            <!-- ìê¸°ì†Œê°œ -->
            <div class="form-group">
                <label class="form-label">ìê¸°ì†Œê°œ</label>
                <textarea name="bio" class="form-control" rows="3" maxlength="200">{{ user.bio }}</textarea>
            </div>

            <!-- í”„ë¡œí•„ ì´ëª¨ì§€ (ë­í‚¹ ë“±ë¡ ì‚¬ìš©ì ë˜ëŠ” ê´€ë¦¬ì) -->
            {% if user.has_ranking or can_customize %}
            <div class="form-group">
                <label class="form-label">í”„ë¡œí•„ ì´ëª¨ì§€ ğŸ…</label>
                <div class="emoji-selector">
                    <span class="emoji-preview" id="emoji-preview">{{ user.profile_emoji|default:"ì„ íƒ" }}</span>
                    <select name="profile_emoji" id="profile-emoji-select" class="form-control">
                        <option value="">ì´ëª¨ì§€ ì—†ìŒ</option>
                        {% for emoji in pikmin_emojis %}
                            <option value="{{ emoji }}" {% if user.profile_emoji == emoji %}selected{% endif %}>
                                {{ emoji }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <small class="form-help">ë‹‰ë„¤ì„ ì™¼ìª½ì— í‘œì‹œë©ë‹ˆë‹¤.</small>
            </div>
            {% endif %}

            <!-- ë°°ì§€ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ (ë­ì»¤ ë˜ëŠ” ê´€ë¦¬ì) -->
            {% if can_customize %}
            <div class="form-group title-selection">
                <label class="form-label">ğŸ¨ ë°°ì§€ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ</label>
                {% if user.special_title %}
                <div class="admin-title-notice">
                    <span class="notice-icon">ğŸ‘‘</span>
                    ê´€ë¦¬ìê°€ ë¶€ì—¬í•œ ì¹­í˜¸ê°€ ìˆìŠµë‹ˆë‹¤: <strong>{{ user.get_special_title_display }}</strong>
                    <br><small>ê´€ë¦¬ì ë¶€ì—¬ ì¹­í˜¸ê°€ ìš°ì„  ì ìš©ë©ë‹ˆë‹¤.</small>
                </div>
                {% endif %}

                <!-- ë¯¸ë¦¬ë³´ê¸° -->
                <div class="title-preview-section">
                    <label class="form-label-small">ë¯¸ë¦¬ë³´ê¸°</label>
                    <div class="title-preview-box">
                        <span class="author-badge" id="title-preview-badge"
                              data-style="{{ user.badge_style }}"
                              data-title="{{ user.selected_title }}">
                            <span class="profile-emoji" id="preview-emoji"
                                  style="{% if not user.profile_emoji %}display:none{% endif %}">{{ user.profile_emoji }}</span>
                            <span class="author-name" id="preview-name">{{ user.nickname }}</span>
                            <span class="special-title-tag" id="preview-title"
                                  style="{% if not user.selected_title %}display:none{% endif %}"></span>
                        </span>
                    </div>
                </div>

                <!-- ì¹­í˜¸ ì„ íƒ -->
                <div class="customize-row">
                    <label class="form-label-small">ì¹­í˜¸</label>
                    <select name="selected_title" id="title-select" class="form-control">
                        <option value="" data-label="">ì¹­í˜¸ ì—†ìŒ</option>
                        {% for code, label in available_titles %}
                        <option value="{{ code }}"
                                {% if user.selected_title == code %}selected{% endif %}
                                data-label="{{ label }}">
                            {{ label }}
                            {% if code == 'explorer' %}(ë‹¬ë¦¬ëŠ”ê±°ë¶ì´ë‹˜ ì „ìš©){% elif code in user.PREMIUM_TITLES and not user.is_admin_user %}(1ìœ„ ì „ìš©){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ìŠ¤íƒ€ì¼ ì„ íƒ -->
                <div class="customize-row">
                    <label class="form-label-small">ìŠ¤íƒ€ì¼</label>
                    <select name="badge_style" id="badge-style-select" class="form-control">
                        {% for code, label in badge_styles %}
                        <option value="{{ code }}" {% if user.badge_style == code %}selected{% endif %}>
                            {{ label }}{% if code == 'underline' %} (ë‹¬ë¦¬ëŠ”ê±°ë¶ì´ë‹˜ ì „ìš©){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ë‹‰ë„¤ì„ ìƒ‰ìƒ -->
                <div class="customize-row">
                    <label class="form-label-small">ë‹‰ë„¤ì„ ìƒ‰ìƒ</label>
                    <select name="nickname_color" id="nickname-color-select" class="form-control">
                        {% for code, label in color_choices %}
                        <option value="{{ code }}" {% if user.nickname_color == code %}selected{% endif %}>
                            {{ label }}{% if code == 'rainbow' %} (ë‹¬ë¦¬ëŠ”ê±°ë¶ì´ë‹˜ ì „ìš©){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ë‹‰ë„¤ì„ ë°°ê²½ ìƒ‰ìƒ -->
                <div class="customize-row">
                    <label class="form-label-small">ë‹‰ë„¤ì„ ë°°ê²½ ìƒ‰ìƒ</label>
                    <select name="nickname_bg_color" id="nickname-bg-color-select" class="form-control">
                        {% for code, label in color_choices %}
                        <option value="{{ code }}" {% if user.nickname_bg_color == code %}selected{% endif %}>
                            {{ label }}{% if code == 'rainbow' %} (ë‹¬ë¦¬ëŠ”ê±°ë¶ì´ë‹˜ ì „ìš©){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ì¹­í˜¸ ê¸€ì ìƒ‰ìƒ -->
                <div class="customize-row">
                    <label class="form-label-small">ì¹­í˜¸ ê¸€ì ìƒ‰ìƒ</label>
                    <select name="title_color" id="title-color-select" class="form-control">
                        {% for code, label in color_choices %}
                        <option value="{{ code }}" {% if user.title_color == code %}selected{% endif %}>
                            {{ label }}{% if code == 'rainbow' %} (ë‹¬ë¦¬ëŠ”ê±°ë¶ì´ë‹˜ ì „ìš©){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ìƒ‰ìƒ ê²½ê³  ë©”ì‹œì§€ -->
                <div class="color-warning" id="color-warning" style="display: none;">
                    âš ï¸ ê¸€ììƒ‰ê³¼ ë°°ê²½ìƒ‰ì´ ê°™ìœ¼ë©´ ê¸€ìê°€ ë³´ì´ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”!
                </div>

                <small class="form-help">
                    {% if user.is_admin_user %}
                    ğŸ‘‘ ê´€ë¦¬ì - ëª¨ë“  ì˜µì…˜ ì‚¬ìš© ê°€ëŠ¥
                    {% elif ranking_position %}
                    ğŸ¥‡ í˜„ì¬ ìˆœìœ„: {{ ranking_position }}ìœ„ |
                    {% if ranking_position == 1 %}ëª¨ë“  ì¹­í˜¸ ì„ íƒ ê°€ëŠ¥{% else %}ì¼ë°˜ ì¹­í˜¸ë§Œ ì„ íƒ ê°€ëŠ¥{% endif %}
                    {% endif %}
                </small>
            </div>
            {% elif ranking_position %}
            <div class="form-group">
                <label class="form-label">ğŸ† íŠ¹ë³„ ì¹­í˜¸</label>
                <p class="form-hint">ìƒìœ„ 3ìœ„ ë‚´ì— ë“¤ë©´ íŠ¹ë³„ ì¹­í˜¸ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            {% endif %}

            <!-- ì´ë©”ì¼ (ì½ê¸° ì „ìš©) -->
            <div class="form-group">
                <label class="form-label">ì´ë©”ì¼</label>
                <input type="email" value="{{ user.email }}" class="form-control" disabled>
                <small class="form-help">ì´ë©”ì¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</small>
            </div>

            <div class="form-actions">
                <a href="{% url 'accounts:my_page' %}" class="btn btn-outline">ì·¨ì†Œ</a>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
        </form>

        <!-- ìœ„í—˜ ì˜ì—­ -->
        <div class="danger-zone card">
            <h3>âš ï¸ ê³„ì • ê´€ë¦¬</h3>
            <p>ë¡œê·¸ì•„ì›ƒí•˜ê±°ë‚˜ ê³„ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
            <div class="danger-actions">
                <a href="{% url 'account_logout' %}" class="btn btn-outline">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>
</div>

<style>
    .settings-page {
        max-width: 600px;
        margin: var(--spacing-xl) auto;
    }

    .page-header {
        margin-bottom: var(--spacing-lg);
    }

    .back-link {
        display: inline-block;
        margin-bottom: var(--spacing-md);
        color: var(--text-secondary);
    }

    .settings-form {
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    .avatar-upload {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
    }

    .current-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
    }

    .current-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-placeholder {
        width: 100%;
        height: 100%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
    }

    .form-group {
        margin-bottom: var(--spacing-lg);
    }

    .form-help {
        display: block;
        margin-top: var(--spacing-xs);
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--bg-tertiary);
    }

    .danger-zone {
        padding: var(--spacing-lg);
        border: 2px solid #FFCDD2;
        background: #FFEBEE;
    }

    .danger-zone h3 {
        color: #C62828;
        margin-bottom: var(--spacing-sm);
    }

    .danger-zone p {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
    }

    /* ì´ëª¨ì§€ ì„ íƒê¸° */
    .emoji-selector {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .emoji-preview {
        font-size: 2.5em;
        min-width: 50px;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed var(--bg-tertiary);
        border-radius: 8px;
        padding: var(--spacing-sm);
    }

    #profile-emoji-select {
        flex: 1;
        font-size: 1.2em;
    }

    /* ì¹­í˜¸ ì„ íƒ ì„¹ì…˜ */
    .title-selection {
        background: linear-gradient(135deg, #FFF8E1, #FFECB3);
        padding: var(--spacing-lg);
        border-radius: var(--radius-lg);
        border: 2px solid #FFD54F;
    }

    .admin-title-notice {
        background: #E8F5E9;
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        border: 1px solid #81C784;
        margin-bottom: var(--spacing-md);
        color: #2E7D32;
    }

    .admin-title-notice .notice-icon {
        font-size: 1.2em;
        margin-right: var(--spacing-xs);
    }

    .title-preview-section {
        background: var(--bg-primary);
        padding: var(--spacing-md);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-md);
    }

    .form-label-small {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-sm);
        display: block;
    }

    .title-preview-box {
        padding: var(--spacing-lg);
        background: #ffffff;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 60px;
        border: 1px solid var(--bg-tertiary);
    }

    .customize-row {
        margin-bottom: var(--spacing-md);
    }

    .customize-row select {
        margin-top: var(--spacing-xs);
    }

    /* ë¯¸ë¦¬ë³´ê¸°ìš© ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .title-preview-box .author-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .title-preview-box .profile-emoji {
        font-size: 1.5em;
        line-height: 1;
        min-width: 1.5em;
        text-align: center;
    }

    .title-preview-box .author-name {
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 4px;
        position: relative;
        transition: all 0.3s ease;
    }

    .title-preview-box .special-title-tag {
        font-size: 0.8em;
        padding: 3px 8px;
        border-radius: 4px;
        background-color: rgba(255, 215, 0, 0.25);
        color: #5D4E0E;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
    }

    /* ============ ìŠ¤íƒ€ì¼ë³„ CSS ============ */

    /* ê¸°ë³¸ (ë°°ê²½ë§Œ) */
    .title-preview-box .author-badge.style-default .author-name {
        background: linear-gradient(135deg, rgba(255, 107, 107, 0.08), rgba(72, 219, 251, 0.08));
    }

    /* ì–¸ë”ë¼ì¸ë§Œ */
    .title-preview-box .author-badge.style-underline .author-name {
        background: transparent;
    }
    .title-preview-box .author-badge.style-underline .author-name::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #a29bfe, #ff6b6b);
        background-size: 200% 100%;
        border-radius: 0 0 4px 4px;
        animation: slide-underline 2s linear infinite;
    }

    /* ë°°ê²½ë§Œ */
    .title-preview-box .author-badge.style-background .author-name {
        background: linear-gradient(135deg, rgba(255, 107, 107, 0.12), rgba(72, 219, 251, 0.12));
        border-radius: 6px;
    }

    /* ê¸€ë¡œìš° íš¨ê³¼ */
    .title-preview-box .author-badge.style-glow .author-name {
        background: transparent;
        text-shadow: 0 0 10px rgba(255, 107, 107, 0.5), 0 0 20px rgba(72, 219, 251, 0.3);
        animation: glow-pulse 2s ease-in-out infinite;
    }
    .title-preview-box .author-badge.style-glow .author-name::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #ff6b6b, #48dbfb);
        box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        border-radius: 1px;
    }

    @keyframes slide-underline {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    @keyframes glow-pulse {
        0%, 100% { text-shadow: 0 0 10px rgba(255, 107, 107, 0.5), 0 0 20px rgba(72, 219, 251, 0.3); }
        50% { text-shadow: 0 0 20px rgba(255, 107, 107, 0.8), 0 0 30px rgba(72, 219, 251, 0.5); }
    }

    /* ============ ìƒ‰ìƒë³„ CSS ============ */
    .title-preview-box .color-red { color: #e74c3c !important; }
    .title-preview-box .color-orange { color: #e67e22 !important; }
    .title-preview-box .color-yellow { color: #d4a000 !important; }
    .title-preview-box .color-green { color: #27ae60 !important; }
    .title-preview-box .color-blue { color: #3498db !important; }
    .title-preview-box .color-purple { color: #9b59b6 !important; }
    .title-preview-box .color-pink { color: #e91e63 !important; }
    .title-preview-box .color-rainbow {
        background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #a29bfe, #ff6b6b) !important;
        background-size: 300% 100% !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        animation: rainbow-shift 3s linear infinite !important;
        text-shadow:
            -1px -1px 0 rgba(0,0,0,0.1),
            1px -1px 0 rgba(0,0,0,0.1),
            -1px 1px 0 rgba(0,0,0,0.1),
            1px 1px 0 rgba(0,0,0,0.1);
        filter: drop-shadow(0 0 1px rgba(0,0,0,0.2));
    }

    @keyframes rainbow-shift {
        0% { background-position: 0% 50%; }
        100% { background-position: 300% 50%; }
    }

    /* ì¹­í˜¸ ê¸€ì ìƒ‰ìƒ - ë°°ê²½ìƒ‰ íˆ¬ëª… ìœ ì§€ */
    .title-preview-box .special-title-tag.title-text-red { color: #c0392b !important; background-color: transparent; }
    .title-preview-box .special-title-tag.title-text-orange { color: #d35400 !important; background-color: transparent; }
    .title-preview-box .special-title-tag.title-text-yellow { color: #a67c00 !important; background-color: transparent; }
    .title-preview-box .special-title-tag.title-text-green { color: #1e8449 !important; background-color: transparent; }
    .title-preview-box .special-title-tag.title-text-blue { color: #2980b9 !important; background-color: transparent; }
    .title-preview-box .special-title-tag.title-text-purple { color: #8e44ad !important; background-color: transparent; }
    .title-preview-box .special-title-tag.title-text-pink { color: #c2185b !important; background-color: transparent; }
    .title-preview-box .special-title-tag.title-text-rainbow {
        background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #a29bfe, #ff6b6b) !important;
        background-size: 300% 100% !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        animation: rainbow-shift 3s linear infinite !important;
    }

    /* í”¼í¬ë¯¼ íƒí—˜ê°€ ì „ìš© ë°˜ì§ì´ëŠ” íš¨ê³¼ - ë°°ê²½ì—ë§Œ ì ìš© */
    .title-preview-box .special-title-tag.title-explorer-shine {
        position: relative;
        overflow: hidden;
        background-color: rgba(255, 215, 0, 0.2) !important;
    }
    .title-preview-box .special-title-tag.title-explorer-shine::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: explorer-shine 2s ease-in-out infinite;
        z-index: -1;
    }

    @keyframes explorer-shine {
        0% { left: -100%; }
        50%, 100% { left: 150%; }
    }

    /* ìƒ‰ìƒ ê²½ê³  ë©”ì‹œì§€ */
    .color-warning {
        background: #FFF3CD;
        border: 1px solid #FFCA28;
        color: #856404;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        margin-top: var(--spacing-md);
        font-size: 0.9rem;
    }

    /* ë‹‰ë„¤ì„ ë°°ê²½ ìƒ‰ìƒ */
    .title-preview-box .author-name.nickname-bg-red { background: rgba(231, 76, 60, 0.15) !important; }
    .title-preview-box .author-name.nickname-bg-orange { background: rgba(230, 126, 34, 0.15) !important; }
    .title-preview-box .author-name.nickname-bg-yellow { background: rgba(241, 196, 15, 0.2) !important; }
    .title-preview-box .author-name.nickname-bg-green { background: rgba(39, 174, 96, 0.15) !important; }
    .title-preview-box .author-name.nickname-bg-blue { background: rgba(52, 152, 219, 0.15) !important; }
    .title-preview-box .author-name.nickname-bg-purple { background: rgba(155, 89, 182, 0.15) !important; }
    .title-preview-box .author-name.nickname-bg-pink { background: rgba(233, 30, 99, 0.15) !important; }
    .title-preview-box .author-name.nickname-bg-rainbow {
        background: linear-gradient(90deg, rgba(255,107,107,0.15), rgba(254,202,87,0.15), rgba(72,219,251,0.15), rgba(162,155,254,0.15)) !important;
        animation: rainbow-bg 3s linear infinite !important;
        background-size: 300% 100% !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const emojiSelect = document.getElementById('profile-emoji-select');
    const emojiPreview = document.getElementById('emoji-preview');
    const titleSelect = document.getElementById('title-select');
    const styleSelect = document.getElementById('badge-style-select');
    const nicknameColorSelect = document.getElementById('nickname-color-select');
    const titleColorSelect = document.getElementById('title-color-select');
    const nicknameBgColorSelect = document.getElementById('nickname-bg-color-select');
    const colorWarning = document.getElementById('color-warning');
    const previewBadge = document.getElementById('title-preview-badge');
    const previewName = document.getElementById('preview-name');
    const previewTitle = document.getElementById('preview-title');
    const previewEmoji = document.getElementById('preview-emoji');

    // ì¹­í˜¸ ì•„ì´ì½˜ ë§¤í•‘ (ì‚¬ìš© ì•ˆí•¨)
    const titleIcons = {};

    // ì´ëª¨ì§€ ë¯¸ë¦¬ë³´ê¸°
    if (emojiSelect && emojiPreview) {
        emojiSelect.addEventListener('change', function() {
            emojiPreview.textContent = this.value || 'ì„ íƒ';
            updatePreview();
        });
    }

    // ëª¨ë“  ì…€ë ‰íŠ¸ì— change ì´ë²¤íŠ¸ ì¶”ê°€
    [titleSelect, styleSelect, nicknameColorSelect, nicknameBgColorSelect, titleColorSelect].forEach(function(select) {
        if (select) {
            select.addEventListener('change', updatePreview);
        }
    });


    // ì´ˆê¸° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updatePreview();

    function updatePreview() {
        if (!previewBadge) return;

        // ì¹­í˜¸ ì •ë³´
        const titleCode = titleSelect ? titleSelect.value : '';
        const selectedOption = titleSelect ? titleSelect.options[titleSelect.selectedIndex] : null;
        const titleLabel = selectedOption ? selectedOption.getAttribute('data-label') : '';

        // ìŠ¤íƒ€ì¼ ë° ìƒ‰ìƒ
        const badgeStyle = styleSelect ? styleSelect.value : 'default';
        const nicknameColor = nicknameColorSelect ? nicknameColorSelect.value : '';
        const nicknameBgColor = nicknameBgColorSelect ? nicknameBgColorSelect.value : '';
        const titleColor = titleColorSelect ? titleColorSelect.value : '';

        // ë°°ì§€ í´ë˜ìŠ¤ ì´ˆê¸°í™”
        previewBadge.className = 'author-badge';

        // ìŠ¤íƒ€ì¼ ì ìš© (ì¹­í˜¸ ì„ íƒê³¼ ë¬´ê´€í•˜ê²Œ ì‚¬ìš©ìê°€ ì„ íƒí•œ ìŠ¤íƒ€ì¼ë§Œ ì ìš©)
        if (badgeStyle && badgeStyle !== 'default') {
            previewBadge.classList.add('style-' + badgeStyle);
        }

        // ë‹‰ë„¤ì„ ìƒ‰ìƒ ì ìš©
        if (previewName) {
            previewName.className = 'author-name';
            if (nicknameColor) {
                previewName.classList.add('color-' + nicknameColor);
            }
            if (nicknameBgColor) {
                previewName.classList.add('nickname-bg-' + nicknameBgColor);
            }
        }

        // ì¹­í˜¸ í‘œì‹œ
        if (previewTitle) {
            if (titleCode && titleLabel) {
                previewTitle.style.display = 'inline';
                previewTitle.textContent = titleLabel;
                previewTitle.className = 'special-title-tag';

                // ìƒ‰ìƒ ë§µí•‘
                const colorMap = {
                    'red': '#c0392b',
                    'orange': '#d35400',
                    'yellow': '#a67c00',
                    'green': '#1e8449',
                    'blue': '#2980b9',
                    'purple': '#8e44ad',
                    'pink': '#c2185b'
                };

                // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                previewTitle.style.color = '';
                previewTitle.style.backgroundColor = '';
                previewTitle.style.background = '';
                previewTitle.style.webkitBackgroundClip = '';
                previewTitle.style.webkitTextFillColor = '';
                previewTitle.style.animation = '';

                // í”¼í¬ë¯¼ íƒí—˜ê°€(explorer)ì¼ ë•Œë§Œ ë°˜ì§ì´ëŠ” íš¨ê³¼ ì ìš©
                if (titleCode === 'explorer') {
                    previewTitle.classList.add('title-explorer-shine');
                }

                // ì¹­í˜¸ ê¸€ì ìƒ‰ìƒ (ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì ìš©)
                if (titleColor && titleColor !== 'rainbow') {
                    previewTitle.style.color = colorMap[titleColor] || '';
                } else if (titleColor === 'rainbow') {
                    previewTitle.classList.add('title-text-rainbow');
                }
            } else {
                previewTitle.style.display = 'none';
            }
        }

        // ìƒ‰ìƒ ê²½ê³  ì²´í¬
        checkColorWarning(nicknameColor, nicknameBgColor);

        // ì´ëª¨ì§€ í‘œì‹œ
        if (previewEmoji) {
            const emoji = emojiSelect ? emojiSelect.value : '';
            if (emoji) {
                previewEmoji.textContent = emoji;
                previewEmoji.style.display = 'inline';
            } else {
                previewEmoji.style.display = 'none';
            }
        }
    }

    // ìƒ‰ìƒ ê²½ê³  ì²´í¬ í•¨ìˆ˜
    function checkColorWarning(nicknameColor, nicknameBgColor) {
        if (!colorWarning) return;

        let showWarning = false;

        // ë‹‰ë„¤ì„: ê¸€ììƒ‰ê³¼ ë°°ê²½ìƒ‰ì´ ê°™ì€ì§€ ì²´í¬ (ë‘˜ ë‹¤ ê°’ì´ ìˆì„ ë•Œë§Œ)
        if (nicknameColor && nicknameBgColor && nicknameColor === nicknameBgColor) {
            showWarning = true;
        }

        colorWarning.style.display = showWarning ? 'block' : 'none';
    }
});
</script>
{% endblock %}
