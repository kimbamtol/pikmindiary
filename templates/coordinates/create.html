{% extends 'base.html' %}

{% block title %}ìƒˆ ì¢Œí‘œ ì œë³´ - í”¼í¬ë¯¼ ë‹¤ì´ì–´ë¦¬{% endblock %}

{% block content %}
<div class="container">
    <div class="form-page">
        <h1 class="page-title">âœï¸ ìƒˆ ì¢Œí‘œ ì œë³´</h1>

        <form method="post" enctype="multipart/form-data" class="coord-form">
            {% csrf_token %}

            <!-- ë¹„íšŒì› í•„ë“œ -->
            {% if not user.is_authenticated %}
            <div class="guest-notice">
                <p>ğŸ’¡ ë¹„íšŒì›ìœ¼ë¡œ ê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤. ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ë‹‰ë„¤ì„ *</label>
                    <input type="text" name="guest_nickname" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸ * <small>(ìˆ˜ì •/ì‚­ì œìš©)</small></label>
                    <input type="password" name="guest_password" class="form-control" required>
                </div>
            </div>
            {% endif %}

            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="form-group">
                <label class="form-label">ì œëª© *</label>
                <input type="text" name="title" class="form-control" placeholder="ì˜ˆ: ê°•ë‚¨ì—­ ê·¼ì²˜ ë²„ì„¯" required
                    maxlength="100">
            </div>

            <div class="form-group">
                <label class="form-label">ì—½ì„œì´ë¦„</label>
                <input type="text" name="postcard_name" class="form-control" placeholder="ì˜ˆ: ê°•ë‚¨ì—­ ì—½ì„œ" maxlength="100">
            </div>

            <div class="form-group">
                <label class="form-label">ì¹´í…Œê³ ë¦¬ *</label>
                <select name="category" class="form-control" required>
                    {% for value, label in categories %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- ì¢Œí‘œ ì…ë ¥ -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ìœ„ë„ (Latitude) *</label>
                    <input type="text" name="latitude" id="latitude" class="form-control" placeholder="ì˜ˆ: 37.498095"
                        required>
                </div>
                <div class="form-group">
                    <label class="form-label">ê²½ë„ (Longitude) *</label>
                    <input type="text" name="longitude" id="longitude" class="form-control" placeholder="ì˜ˆ: 127.027610"
                        required>
                </div>
            </div>

            <div class="location-btn-row">
                <button type="button" class="btn btn-location" id="useMyLocationBtn">
                    ğŸ“ ë‚´ ìœ„ì¹˜ ì…ë ¥í•˜ê¸°
                </button>
                <button type="button" class="btn btn-map-picker" id="openMapPickerBtn">
                    ğŸ—ºï¸ ì§€ë„ì—ì„œ ì„ íƒ
                </button>
                <span id="locationStatus"></span>
            </div>

            <div class="coords-help">
                <p>ğŸ’¡ ì¢Œí‘œ ì…ë ¥ ë°©ë²•:</p>
                <ol>
                    <li><strong>ğŸ“ ë‚´ ìœ„ì¹˜ ì…ë ¥í•˜ê¸°</strong> ë²„íŠ¼ìœ¼ë¡œ í˜„ì¬ ìœ„ì¹˜ ìë™ ì…ë ¥</li>
                    <li><strong>ğŸ—ºï¸ ì§€ë„ì—ì„œ ì„ íƒ</strong> ë²„íŠ¼ìœ¼ë¡œ ì§€ë„ì—ì„œ ì§ì ‘ ìœ„ì¹˜ ì„ íƒ</li>
                    <li>ë˜ëŠ” ê²Œì„ ë‚´ì—ì„œ ê³µìœ í•˜ê¸° â†’ ì¢Œí‘œ í™•ì¸</li>
                </ol>
            </div>

            <!-- ì„¤ëª… -->
            <div class="form-group">
                <label class="form-label">ì„¤ëª…</label>
                <textarea name="description" class="form-control" rows="4" placeholder="ìœ„ì¹˜ì— ëŒ€í•œ ì¶”ê°€ ì„¤ëª… (ì„ íƒì‚¬í•­)"></textarea>
            </div>

            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
            <div class="form-group">
                <label class="form-label">ì´ë¯¸ì§€ (ìµœëŒ€ 5ì¥)</label>
                <input type="file" name="images" id="images" class="form-control"
                    accept="image/jpeg,image/png,image/webp" multiple onchange="previewImages(this)">
                <small class="form-help">JPEG, PNG, WebP í˜•ì‹, ê° ìµœëŒ€ 5MB</small>
                <div id="image-preview" class="image-preview"></div>
            </div>

            <!-- ì›Œí„°ë§ˆí¬ ì˜µì…˜ -->
            <div class="form-group watermark-option">
                <label class="checkbox-label">
                    <input type="checkbox" name="watermark_enabled" id="watermark_enabled" onchange="toggleWatermarkName()">
                    <span class="checkbox-text">ğŸ”’ ì‚¬ì§„ì— ë‹‰ë„¤ì„ ì›Œí„°ë§ˆí¬ í‘œì‹œ</span>
                </label>
                <small class="form-help">ì²´í¬í•˜ë©´ ì—…ë¡œë“œëœ ëª¨ë“  ì‚¬ì§„ ì¢Œìƒë‹¨/ìš°í•˜ë‹¨ì— ë‹‰ë„¤ì„ì´ ë°˜íˆ¬ëª…í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤.</small>

                <div id="watermark-name-field" class="watermark-name-field" style="display: none;">
                    <label class="form-label">ì›Œí„°ë§ˆí¬ ë‹‰ë„¤ì„ (ì„ íƒ)</label>
                    <input type="text" name="watermark_name" class="form-control"
                           placeholder="ë¹„ì›Œë‘ë©´ ì‘ì„±ì ë‹‰ë„¤ì„ ì‚¬ìš©" maxlength="50">
                    <small class="form-help">ì›Œí„°ë§ˆí¬ì— í‘œì‹œë  ì´ë¦„ì„ ì§ì ‘ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>
            </div>

            <!-- ì£¼ì˜ì‚¬í•­ -->
            <div class="notice-box">
                <h3>âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
                <ul>
                    <li>í—ˆìœ„ ì¢Œí‘œ ì œë³´ ì‹œ ê³„ì •ì´ ì •ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    <li>ğŸ“¢ í˜„ì¬ëŠ” ìŠ¹ì¸ ì—†ì´ ë°”ë¡œ ê²Œì‹œë©ë‹ˆë‹¤! (ë‹¹ë¶„ê°„ ìš´ì˜)</li>
                    <li>ê°œì¸ì •ë³´ê°€ í¬í•¨ëœ ìŠ¤í¬ë¦°ìƒ·ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.</li>
                </ul>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="form-actions">
                <a href="{% url 'coordinates:list' %}" class="btn btn-outline">ì·¨ì†Œ</a>
                <button type="submit" class="btn btn-primary btn-lg">ì œì¶œí•˜ê¸°</button>
            </div>
        </form>
    </div>
</div>
<!-- ì§€ë„ ì„ íƒ ëª¨ë‹¬ -->
<div id="mapPickerModal" class="map-picker-modal">
    <div class="map-picker-header">
        <h2>ğŸ“ ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</h2>
        <button type="button" class="map-picker-close" id="closeMapPickerBtn">&times;</button>
    </div>
    <div class="map-search-bar">
        <input type="text" id="mapSearchInput" class="map-search-input" placeholder="ğŸ” ì¥ì†Œ, ì£¼ì†Œ, ê±´ë¬¼ëª… ê²€ìƒ‰...">
        <button type="button" class="btn btn-search" id="mapSearchBtn">ê²€ìƒ‰</button>
    </div>
    <div id="mapSearchResults" class="map-search-results"></div>
    <div id="mapPickerContainer" class="map-picker-container"></div>
    <div class="map-picker-footer">
        <div class="map-picker-coords">
            <span id="selectedCoordsDisplay">ì§€ë„ë¥¼ í„°ì¹˜í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
        </div>
        <div class="map-picker-actions">
            <button type="button" class="btn btn-outline" id="cancelMapPickerBtn">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" id="confirmMapPickerBtn" disabled>ì„ íƒ ì™„ë£Œ</button>
        </div>
    </div>
</div>

<!-- Leaflet CSS/JS for map picker -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    .form-page {
        max-width: 700px;
        margin: var(--spacing-xl) auto;
        padding: var(--spacing-xl);
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
    }

    .page-title {
        text-align: center;
        margin-bottom: var(--spacing-xl);
    }

    .guest-notice {
        padding: var(--spacing-md);
        background: #FFF3E0;
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        color: #E65100;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
    }

    .form-group {
        margin-bottom: var(--spacing-lg);
    }

    .form-label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-weight: 600;
    }

    .form-label small {
        font-weight: 400;
        color: var(--text-secondary);
    }

    .form-help {
        display: block;
        margin-top: var(--spacing-xs);
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .location-btn-row {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .btn-location {
        background: #3498db;
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
    }

    .btn-location:hover {
        background: #2980b9;
    }

    .btn-location:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }

    .coords-help {
        padding: var(--spacing-md);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        font-size: 0.9rem;
    }

    .coords-help p {
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
    }

    .coords-help ol {
        padding-left: var(--spacing-lg);
        color: var(--text-secondary);
        list-style: decimal;
    }

    .coords-help li {
        margin-bottom: var(--spacing-xs);
    }

    .image-preview {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
        flex-wrap: wrap;
    }

    .preview-image {
        position: relative;
        width: 100px;
        height: 100px;
    }

    .preview-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: var(--radius-md);
    }

    .preview-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #F44336;
        color: white;
        border-radius: 50%;
        font-size: 1rem;
        line-height: 1;
        cursor: pointer;
    }

    /* ì›Œí„°ë§ˆí¬ ì˜µì…˜ */
    .watermark-option {
        padding: var(--spacing-md);
        background: #E3F2FD;
        border-radius: var(--radius-md);
        border: 1px solid #90CAF9;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .checkbox-text {
        font-weight: 600;
        color: var(--text-primary);
    }

    .watermark-name-field {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid #90CAF9;
    }

    .notice-box {
        padding: var(--spacing-md);
        background: #FFEBEE;
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
    }

    .notice-box h3 {
        margin-bottom: var(--spacing-sm);
        color: #C62828;
    }

    .notice-box ul {
        padding-left: var(--spacing-lg);
        color: #B71C1C;
        list-style: disc;
    }

    .notice-box li {
        margin-bottom: var(--spacing-xs);
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-md);
    }

    @media (max-width: 480px) {
        .form-page {
            padding: var(--spacing-md);
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column-reverse;
        }

        .location-btn-row {
            flex-direction: column;
            align-items: stretch;
        }
    }

    /* ì§€ë„ì—ì„œ ì„ íƒ ë²„íŠ¼ */
    .btn-map-picker {
        background: #27ae60;
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
    }

    .btn-map-picker:hover {
        background: #219a52;
    }

    /* ì§€ë„ ì„ íƒ ëª¨ë‹¬ */
    .map-picker-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-primary);
        z-index: 10000;
        flex-direction: column;
    }

    .map-picker-modal.active {
        display: flex;
    }

    .map-picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .map-picker-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }

    .map-picker-close {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: var(--text-secondary);
        line-height: 1;
        padding: 0;
    }

    .map-picker-close:hover {
        color: var(--text-primary);
    }

    /* ì§€ë„ ê²€ìƒ‰ ë°” */
    .map-search-bar {
        display: flex;
        padding: var(--spacing-sm) var(--spacing-lg);
        gap: var(--spacing-sm);
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
    }

    .map-search-input {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 1rem;
    }

    .map-search-input:focus {
        outline: none;
        border-color: #27ae60;
        box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
    }

    .btn-search {
        background: #27ae60;
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 600;
        white-space: nowrap;
    }

    .btn-search:hover {
        background: #219a52;
    }

    .btn-search:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ */
    .map-search-results {
        max-height: 200px;
        overflow-y: auto;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
        display: none;
    }

    .map-search-results.active {
        display: block;
    }

    .search-result-item {
        padding: var(--spacing-sm) var(--spacing-lg);
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
    }

    .search-result-item:hover {
        background: var(--bg-secondary);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-name {
        font-weight: 600;
        color: var(--text-primary);
    }

    .search-result-address {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    .search-no-results {
        padding: var(--spacing-md) var(--spacing-lg);
        text-align: center;
        color: var(--text-secondary);
    }

    .search-loading {
        padding: var(--spacing-md) var(--spacing-lg);
        text-align: center;
        color: var(--text-secondary);
    }

    .map-picker-container {
        flex: 1;
        min-height: 0;
    }

    .map-picker-footer {
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--bg-secondary);
        border-top: 1px solid var(--border-color);
    }

    .map-picker-coords {
        text-align: center;
        margin-bottom: var(--spacing-md);
        font-weight: 600;
        color: var(--text-primary);
    }

    .map-picker-actions {
        display: flex;
        justify-content: center;
        gap: var(--spacing-md);
    }

    .map-picker-actions .btn {
        min-width: 120px;
    }

    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    .map-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .map-loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #27ae60;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .map-loading-text {
        margin-top: var(--spacing-md);
        color: var(--text-secondary);
    }
</style>

<script>
    function toggleWatermarkName() {
        const checkbox = document.getElementById('watermark_enabled');
        const nameField = document.getElementById('watermark-name-field');
        if (checkbox.checked) {
            nameField.style.display = 'block';
        } else {
            nameField.style.display = 'none';
        }
    }

    function previewImages(input) {
        const previewContainer = document.getElementById('image-preview');
        previewContainer.innerHTML = '';

        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.className = 'preview-image';
                    div.innerHTML = `<img src="${e.target.result}">`;
                    previewContainer.appendChild(div);
                }
                reader.readAsDataURL(file);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const latInput = document.querySelector('input[name="latitude"]');
        const lngInput = document.querySelector('input[name="longitude"]');

        if (latInput && lngInput) {
            latInput.addEventListener('input', function (e) {
                const value = e.target.value;
                if (value.includes(',')) {
                    const parts = value.split(',');
                    if (parts.length === 2) {
                        const lat = parts[0].trim();
                        const lng = parts[1].trim();

                        latInput.value = lat;
                        lngInput.value = lng;

                        lngInput.focus();
                    }
                }
            });
        }

        // ë‚´ ìœ„ì¹˜ ì…ë ¥í•˜ê¸° ë²„íŠ¼
        const locationBtn = document.getElementById('useMyLocationBtn');
        const locationStatus = document.getElementById('locationStatus');

        if (locationBtn) {
            locationBtn.addEventListener('click', function () {
                if (!navigator.geolocation) {
                    locationStatus.textContent = 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    locationStatus.style.color = 'red';
                    return;
                }

                locationBtn.disabled = true;
                locationBtn.textContent = 'ğŸ“ ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...';
                locationStatus.textContent = '';

                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);

                        if (latInput) latInput.value = lat;
                        if (lngInput) lngInput.value = lng;

                        locationBtn.disabled = false;
                        locationBtn.textContent = 'ğŸ“ ë‚´ ìœ„ì¹˜ ì…ë ¥í•˜ê¸°';
                        locationStatus.textContent = 'âœ… ìœ„ì¹˜ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
                        locationStatus.style.color = 'green';
                    },
                    function (error) {
                        locationBtn.disabled = false;
                        locationBtn.textContent = 'ğŸ“ ë‚´ ìœ„ì¹˜ ì…ë ¥í•˜ê¸°';

                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                locationStatus.textContent = 'âŒ ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                locationStatus.textContent = 'âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                                break;
                            case error.TIMEOUT:
                                locationStatus.textContent = 'âŒ ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ ì´ˆê³¼';
                                break;
                            default:
                                locationStatus.textContent = 'âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                        }
                        locationStatus.style.color = 'red';
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        // ========================================
        // ì§€ë„ì—ì„œ ì„ íƒ ê¸°ëŠ¥
        // ========================================
        const mapPickerBtn = document.getElementById('openMapPickerBtn');
        const mapPickerModal = document.getElementById('mapPickerModal');
        const closeMapPickerBtn = document.getElementById('closeMapPickerBtn');
        const cancelMapPickerBtn = document.getElementById('cancelMapPickerBtn');
        const confirmMapPickerBtn = document.getElementById('confirmMapPickerBtn');
        const selectedCoordsDisplay = document.getElementById('selectedCoordsDisplay');
        const mapContainer = document.getElementById('mapPickerContainer');
        const mapSearchInput = document.getElementById('mapSearchInput');
        const mapSearchBtn = document.getElementById('mapSearchBtn');
        const mapSearchResults = document.getElementById('mapSearchResults');

        let pickerMap = null;
        let pickerMarker = null;
        let selectedLat = null;
        let selectedLng = null;

        // ê¸°ë³¸ ìœ„ì¹˜ (ì„œìš¸)
        const defaultLat = 37.5665;
        const defaultLng = 126.9780;

        // ëª¨ë‹¬ ì—´ê¸°
        if (mapPickerBtn) {
            mapPickerBtn.addEventListener('click', function () {
                openMapPicker();
            });
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        if (closeMapPickerBtn) {
            closeMapPickerBtn.addEventListener('click', closeMapPicker);
        }
        if (cancelMapPickerBtn) {
            cancelMapPickerBtn.addEventListener('click', closeMapPicker);
        }

        // ì„ íƒ ì™„ë£Œ
        if (confirmMapPickerBtn) {
            confirmMapPickerBtn.addEventListener('click', function () {
                if (selectedLat !== null && selectedLng !== null) {
                    if (latInput) latInput.value = selectedLat.toFixed(6);
                    if (lngInput) lngInput.value = selectedLng.toFixed(6);
                    locationStatus.textContent = 'âœ… ì§€ë„ì—ì„œ ìœ„ì¹˜ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!';
                    locationStatus.style.color = 'green';
                    closeMapPicker();
                }
            });
        }

        function openMapPicker() {
            mapPickerModal.classList.add('active');
            document.body.style.overflow = 'hidden'; // ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€

            // ë¡œë”© í‘œì‹œ
            mapContainer.innerHTML = `
                <div class="map-loading-overlay">
                    <div class="map-loading-spinner"></div>
                    <div class="map-loading-text">ğŸ“ í˜„ì¬ ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ì¤‘...</div>
                </div>
            `;

            // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
            selectedLat = null;
            selectedLng = null;
            selectedCoordsDisplay.textContent = 'ì§€ë„ë¥¼ í„°ì¹˜í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”';
            confirmMapPickerBtn.disabled = true;

            // GPSë¡œ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        initializePickerMap(position.coords.latitude, position.coords.longitude);
                    },
                    function (error) {
                        console.log('GPS ì˜¤ë¥˜:', error);
                        // GPS ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ìœ„ì¹˜(ì„œìš¸) ì‚¬ìš©
                        initializePickerMap(defaultLat, defaultLng);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                // Geolocation ë¯¸ì§€ì› ì‹œ ê¸°ë³¸ ìœ„ì¹˜
                initializePickerMap(defaultLat, defaultLng);
            }
        }

        function initializePickerMap(lat, lng) {
            // ê¸°ì¡´ ë¡œë”© ì œê±°
            mapContainer.innerHTML = '';

            // ì§€ë„ ì´ˆê¸°í™”
            pickerMap = L.map('mapPickerContainer').setView([lat, lng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(pickerMap);

            // í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ (íŒŒë€ ì›)
            L.circle([lat, lng], {
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.3,
                radius: 50
            }).addTo(pickerMap);

            // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ (ì‘ì€ íŒŒë€ ì )
            L.circleMarker([lat, lng], {
                radius: 8,
                color: '#fff',
                weight: 2,
                fillColor: '#3498db',
                fillOpacity: 1
            }).addTo(pickerMap).bindPopup('ğŸ“ í˜„ì¬ ìœ„ì¹˜').openPopup();

            // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
            pickerMap.on('click', function (e) {
                const clickLat = e.latlng.lat;
                const clickLng = e.latlng.lng;

                // ê¸°ì¡´ ì„ íƒ ë§ˆì»¤ ì œê±°
                if (pickerMarker) {
                    pickerMap.removeLayer(pickerMarker);
                }

                // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                pickerMarker = L.marker([clickLat, clickLng], {
                    icon: L.divIcon({
                        className: 'selected-location-marker',
                        html: '<div style="font-size: 32px; text-align: center;">ğŸ“</div>',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    })
                }).addTo(pickerMap);

                // ì„ íƒëœ ì¢Œí‘œ ì €ì¥
                selectedLat = clickLat;
                selectedLng = clickLng;

                // UI ì—…ë°ì´íŠ¸
                selectedCoordsDisplay.innerHTML = `
                    <span style="color: #27ae60;">âœ… ì„ íƒë¨:</span> 
                    ìœ„ë„ ${clickLat.toFixed(6)}, ê²½ë„ ${clickLng.toFixed(6)}
                `;
                confirmMapPickerBtn.disabled = false;
            });

            // ì§€ë„ í¬ê¸° ì¡°ì • (ëª¨ë‹¬ì´ ì—´ë¦° í›„ í•„ìš”)
            setTimeout(() => {
                pickerMap.invalidateSize();
            }, 100);
        }

        function closeMapPicker() {
            mapPickerModal.classList.remove('active');
            document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›

            // ì§€ë„ ì •ë¦¬
            if (pickerMap) {
                pickerMap.remove();
                pickerMap = null;
            }
            pickerMarker = null;

            // ê²€ìƒ‰ ì´ˆê¸°í™”
            if (mapSearchInput) mapSearchInput.value = '';
            if (mapSearchResults) {
                mapSearchResults.innerHTML = '';
                mapSearchResults.classList.remove('active');
            }
        }

        // ========================================
        // ì§€ë„ ê²€ìƒ‰ ê¸°ëŠ¥ (Nominatim)
        // ========================================
        if (mapSearchBtn) {
            mapSearchBtn.addEventListener('click', performMapSearch);
        }

        if (mapSearchInput) {
            mapSearchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performMapSearch();
                }
            });
        }

        function performMapSearch() {
            const query = mapSearchInput.value.trim();
            if (!query) return;

            // ë¡œë”© í‘œì‹œ
            mapSearchResults.innerHTML = '<div class="search-loading">ğŸ” ê²€ìƒ‰ ì¤‘...</div>';
            mapSearchResults.classList.add('active');
            mapSearchBtn.disabled = true;

            // Nominatim API í˜¸ì¶œ (í•œêµ­ ìš°ì„ )
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=kr&accept-language=ko`)
                .then(response => response.json())
                .then(data => {
                    mapSearchBtn.disabled = false;

                    if (data.length === 0) {
                        // í•œêµ­ ê²°ê³¼ ì—†ìœ¼ë©´ ì „ì²´ ê²€ìƒ‰
                        return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=ko`)
                            .then(response => response.json());
                    }
                    return data;
                })
                .then(data => {
                    mapSearchBtn.disabled = false;

                    if (data.length === 0) {
                        mapSearchResults.innerHTML = '<div class="search-no-results">ğŸ˜¢ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                        return;
                    }

                    // ê²°ê³¼ í‘œì‹œ
                    mapSearchResults.innerHTML = data.map(item => `
                        <div class="search-result-item" data-lat="${item.lat}" data-lon="${item.lon}">
                            <div class="search-result-name">${item.display_name.split(',')[0]}</div>
                            <div class="search-result-address">${item.display_name}</div>
                        </div>
                    `).join('');

                    // ê²°ê³¼ í´ë¦­ ì´ë²¤íŠ¸
                    mapSearchResults.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('click', function () {
                            const lat = parseFloat(this.dataset.lat);
                            const lon = parseFloat(this.dataset.lon);

                            // ì§€ë„ ì´ë™
                            if (pickerMap) {
                                pickerMap.setView([lat, lon], 17);

                                // ë§ˆì»¤ ì¶”ê°€
                                if (pickerMarker) {
                                    pickerMap.removeLayer(pickerMarker);
                                }

                                pickerMarker = L.marker([lat, lon], {
                                    icon: L.divIcon({
                                        className: 'selected-location-marker',
                                        html: '<div style="font-size: 32px; text-align: center;">ğŸ“</div>',
                                        iconSize: [40, 40],
                                        iconAnchor: [20, 40]
                                    })
                                }).addTo(pickerMap);

                                // ì„ íƒëœ ì¢Œí‘œ ì €ì¥
                                selectedLat = lat;
                                selectedLng = lon;

                                // UI ì—…ë°ì´íŠ¸
                                selectedCoordsDisplay.innerHTML = `
                                    <span style="color: #27ae60;">âœ… ì„ íƒë¨:</span> 
                                    ìœ„ë„ ${lat.toFixed(6)}, ê²½ë„ ${lon.toFixed(6)}
                                `;
                                confirmMapPickerBtn.disabled = false;
                            }

                            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
                            mapSearchResults.classList.remove('active');
                            mapSearchInput.value = '';
                        });
                    });
                })
                .catch(error => {
                    console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    mapSearchBtn.disabled = false;
                    mapSearchResults.innerHTML = '<div class="search-no-results">âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
                });
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && mapPickerModal.classList.contains('active')) {
                closeMapPicker();
            }
        });
    });
</script>
{% endblock %}