{% extends 'base.html' %}
{% load static %}

{% block title %}í”¼í¬ë¯¼ ì¢Œí‘œ ì§€ë„ - ë²„ì„¯, ëª¨ì¢…, ë¹…í”Œë¼ì›Œ ìœ„ì¹˜ ì§€ë„ | í”¼í¬ë¯¼ ë‹¤ì´ì–´ë¦¬{% endblock %}
{% block description %}í”¼í¬ë¯¼ ë¸”ë£¸ ì§€ë„ë¡œ ì£¼ë³€ ë²„ì„¯, ëª¨ì¢…, ë¹…í”Œë¼ì›Œ ì¢Œí‘œë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”. í”¼í¬ë¯¼ ì—½ì„œ ìœ„ì¹˜ë¥¼ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.{% endblock %}
{% block og_title %}í”¼í¬ë¯¼ ì¢Œí‘œ ì§€ë„ - í”¼í¬ë¯¼ ë¸”ë£¸ ìœ„ì¹˜ ì§€ë„{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
    .map-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 60px);
    }

    #map {
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    .map-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: left 0.3s ease;
    }

    .map-controls.sidebar-open {
        left: 330px;
    }

    .map-filters {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }

    .back-btn,
    .list-btn,
    .location-btn,
    .report-btn {
        background: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        font-weight: 600;
        color: var(--primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .back-btn:hover,
    .list-btn:hover,
    .location-btn:hover {
        background: var(--primary);
        color: white;
    }

    .report-btn {
        background: #3498db;
        color: white;
    }

    .report-btn:hover {
        background: #2980b9;
    }

    .list-btn.active,
    .location-btn.active {
        background: var(--primary);
        color: white;
    }

    .filter-box {
        background: white;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .filter-box label {
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .filter-box input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }

    /* ë¦¬ìŠ¤íŠ¸ ì‚¬ì´ë“œë°” */
    .list-sidebar {
        position: absolute;
        top: 0;
        left: 0;
        width: 320px;
        height: 100%;
        background: white;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        z-index: 1002;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .list-sidebar.open {
        transform: translateX(0);
    }

    .list-header {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--primary);
        color: white;
    }

    .list-header h3 {
        margin: 0;
        font-size: 1rem;
    }

    .list-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .list-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .list-item {
        display: flex;
        gap: 10px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #eee;
    }

    .list-item:hover {
        background: #f5f5f5;
    }

    .list-item-image {
        width: 60px;
        height: 60px;
        border-radius: 6px;
        object-fit: cover;
        flex-shrink: 0;
    }

    .list-item-placeholder {
        width: 60px;
        height: 60px;
        border-radius: 6px;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .list-item-info {
        flex: 1;
        min-width: 0;
    }

    .list-item-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .list-item-meta {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .list-item-stats {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    .list-empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }

    /* Custom marker popup */
    .coord-popup {
        min-width: 200px;
    }

    .coord-popup-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .coord-popup-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
        color: var(--text-primary);
    }

    .coord-popup-meta {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .coord-popup-stats {
        display: flex;
        gap: 12px;
        font-size: 0.85rem;
        margin-bottom: 8px;
    }

    .coord-popup-link {
        display: block;
        text-align: center;
        background: var(--primary);
        color: white;
        padding: 8px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
    }

    .coord-popup-link:hover {
        background: var(--primary-dark);
    }

    /* Custom cluster icons */
    .marker-cluster-small {
        background-color: rgba(110, 204, 57, 0.6);
    }

    .marker-cluster-small div {
        background-color: rgba(110, 204, 57, 0.8);
    }

    .marker-cluster-medium {
        background-color: rgba(240, 194, 12, 0.6);
    }

    .marker-cluster-medium div {
        background-color: rgba(240, 194, 12, 0.8);
    }

    .marker-cluster-large {
        background-color: rgba(241, 128, 23, 0.6);
    }

    .marker-cluster-large div {
        background-color: rgba(241, 128, 23, 0.8);
    }

    .marker-cluster {
        background-clip: padding-box;
        border-radius: 20px;
    }

    .marker-cluster div {
        width: 30px;
        height: 30px;
        margin-left: 5px;
        margin-top: 5px;
        text-align: center;
        border-radius: 15px;
        font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    @media (max-width: 768px) {
        .list-sidebar {
            width: 100%;
        }

        .filter-box {
            flex-wrap: wrap;
            font-size: 0.8rem;
        }

        .filter-box label {
            font-size: 0.8rem;
        }
    }

    /* ë³µì‚¬ ë²„íŠ¼ */
    .copy-btn {
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .copy-btn:hover {
        background: rgba(52, 152, 219, 0.2);
    }

    /* í† ìŠ¤íŠ¸ */
    .map-toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: #333;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.95rem;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        text-align: center;
        line-height: 1.6;
    }

    .map-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .map-toast small {
        font-size: 0.78rem;
        opacity: 0.85;
    }

    /* íŒì—… ë³µì‚¬ ë²„íŠ¼ */
    .popup-copy-btn {
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .popup-copy-btn:hover {
        background: rgba(52, 152, 219, 0.3);
    }

    /* ì§€ë„ ê²€ìƒ‰ ë°” */
    .map-search-box {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }

    .map-view-search-input {
        flex: 1;
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .map-view-search-input:focus {
        outline: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }

    .map-view-search-btn {
        background: #27ae60;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .map-view-search-btn:hover {
        background: #219a52;
    }

    .map-view-search-btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ */
    .map-view-search-results {
        max-height: 250px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        margin-top: 8px;
        display: none;
    }

    .map-view-search-results.active {
        display: block;
    }

    .map-view-result-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }

    .map-view-result-item:hover {
        background: #f5f5f5;
    }

    .map-view-result-item:last-child {
        border-bottom: none;
    }

    .map-view-result-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .map-view-result-address {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .map-view-no-results {
        padding: 15px;
        text-align: center;
        color: var(--text-secondary);
    }

    .map-view-loading {
        padding: 15px;
        text-align: center;
        color: var(--text-secondary);
    }

    @media (max-width: 768px) {

        /* ëª¨ë°”ì¼ì—ì„œ ê²€ìƒ‰ ë°”ë¥¼ í•˜ë‹¨ì— ë°°ì¹˜ */
        .map-filters {
            top: auto;
            bottom: 20px;
            right: 10px;
            left: 10px;
            flex-direction: column-reverse;
        }

        .filter-box {
            font-size: 0.75rem;
            padding: 8px 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-box label {
            font-size: 0.75rem;
        }

        .map-search-box {
            flex-direction: row;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .map-view-search-input {
            flex: 1;
        }

        .map-view-search-btn {
            padding: 10px 15px;
        }

        .map-view-search-results {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 8px;
            max-height: 200px;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ì¤Œ ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ ì¡°ì • */
        .leaflet-control-zoom {
            margin-bottom: 140px !important;
        }
    }

    /* ì¤Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .leaflet-control-zoom a {
        width: 36px !important;
        height: 36px !important;
        line-height: 36px !important;
        font-size: 18px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <!-- ì™¼ìª½ ì»¨íŠ¸ë¡¤ -->
    <div class="map-controls">
        <a href="{% url 'coordinates:list' %}" class="back-btn">
            â† ëª©ë¡ìœ¼ë¡œ
        </a>
        <button class="list-btn" id="listToggle">
            ğŸ“‹ ë¦¬ìŠ¤íŠ¸ (<span id="visibleCount">0</span>)
        </button>
        <button class="location-btn" id="myLocationBtn">
            ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ
        </button>
        <a href="{% url 'coordinates:create' %}?from_map=1" class="report-btn" id="reportBtn">
            â• ì œë³´í•˜ê¸°
        </a>
    </div>

    <!-- ì˜¤ë¥¸ìª½ í•„í„° -->
    <div class="map-filters">
        <div class="filter-box">
            <label><input type="checkbox" class="category-filter" value="MUSHROOM" checked> ğŸ„ ë²„ì„¯</label>
            <label><input type="checkbox" class="category-filter" value="BIGFLOWER" checked> ğŸŒ¸ ë¹…í”Œë¼ì›Œ</label>
            <label><input type="checkbox" class="category-filter" value="SEEDLING" checked> ğŸŒ± ëª¨ì¢…</label>
            <label><input type="checkbox" class="category-filter" value="OTHER" checked> ğŸ“ ê¸°íƒ€</label>
        </div>
        <!-- ê²€ìƒ‰ ë°” -->
        <div class="map-search-box">
            <input type="text" id="mapViewSearchInput" class="map-view-search-input" placeholder="ğŸ” ì¥ì†Œ, ì£¼ì†Œ ê²€ìƒ‰...">
            <button type="button" class="map-view-search-btn" id="mapViewSearchBtn">ê²€ìƒ‰</button>
        </div>
        <div id="mapViewSearchResults" class="map-view-search-results"></div>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ ì‚¬ì´ë“œë°” -->
    <div class="list-sidebar" id="listSidebar">
        <div class="list-header">
            <h3>ğŸ“‹ í˜„ì¬ í™”ë©´ (<span id="sidebarCount">0</span>ê°œ)</h3>
            <button class="list-close" id="listClose">Ã—</button>
        </div>
        <div class="list-content" id="listContent">
            <div class="list-empty">ì§€ë„ë¥¼ ì´ë™í•˜ë©´ ë³´ì´ëŠ” ê²Œì‹œê¸€ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
    </div>

    <div id="map"></div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    // ë§ˆì»¤ ë°ì´í„°
    const markersData = {{ markers_json| safe }};

    // ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´ì½˜
    const categoryIcons = {
        'MUSHROOM': 'ğŸ„',
        'BIGFLOWER': 'ğŸŒ¸',
        'SEEDLING': 'ğŸŒ±',
        'OTHER': 'ğŸ“'
    };

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜
    function showToast(message) {
        // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
        const existingToast = document.querySelector('.map-toast');
        if (existingToast) existingToast.remove();

        // ìƒˆ í† ìŠ¤íŠ¸ ìƒì„±
        const toast = document.createElement('div');
        toast.className = 'map-toast';
        toast.innerHTML = message;
        document.body.appendChild(toast);

        // ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }

    // ì§€ë„ ì´ˆê¸°í™” (ì„¸ê³„ ì¤‘ì‹¬, ê¸°ë³¸ ì¤Œ ì»¨íŠ¸ë¡¤ ë¹„í™œì„±í™”)
    const map = L.map('map', {
        zoomControl: false  // ê¸°ë³¸ ì¤Œ ì»¨íŠ¸ë¡¤ ë¹„í™œì„±í™”
    }).setView([30, 10], 2);

    // ì¤Œ ì»¨íŠ¸ë¡¤ ìš°ì¸¡ í•˜ë‹¨ì— ì¶”ê°€
    L.control.zoom({
        position: 'bottomright'
    }).addTo(map);

    // OpenStreetMap íƒ€ì¼ ì¶”ê°€
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹
    const markerCluster = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });

    // ëª¨ë“  ë§ˆì»¤ì™€ ë°ì´í„° ì €ì¥
    const allMarkers = [];

    // ë§ˆì»¤ ìƒì„±
    markersData.forEach(function (coord) {
        const icon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">' + (categoryIcons[coord.category] || 'ğŸ“') + '</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        const marker = L.marker([coord.lat, coord.lng], { icon: icon });
        marker.coordData = coord; // ë§ˆì»¤ì— ë°ì´í„° ì €ì¥

        // íŒì—… ë‚´ìš©
        let popupContent = '<div class="coord-popup">';
        if (coord.image) {
            popupContent += '<img src="' + coord.image + '" class="coord-popup-image" alt="' + coord.title + '">';
        }
        popupContent += '<div class="coord-popup-title">' + coord.title + '</div>';
        popupContent += '<div class="coord-popup-meta">' + coord.category_display + ' Â· ' + coord.region_display + '</div>';
        popupContent += '<div class="coord-popup-stats">';
        popupContent += '<span class="popup-copy-btn" data-id="' + coord.id + '" data-coords="' + coord.lat + ', ' + coord.lng + '" title="ì¢Œí‘œ ë³µì‚¬">ğŸ“‹ <span class="popup-copy-count">' + coord.copy_count + '</span></span>';
        popupContent += '<span>â¤ï¸ ' + coord.like_count + '</span>';
        popupContent += '</div>';
        popupContent += '<a href="/coordinates/' + coord.id + '/" class="coord-popup-link">ìƒì„¸ë³´ê¸° â†’</a></div>';

        marker.bindPopup(popupContent, { maxWidth: 250 });

        allMarkers.push(marker);
        markerCluster.addLayer(marker);
    });

    map.addLayer(markerCluster);

    // ë§ˆì»¤ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë²”ìœ„ë¡œ ì´ë™
    if (markersData.length > 0) {
        const bounds = markerCluster.getBounds();
        map.fitBounds(bounds, { padding: [30, 30] });
    }

    // íŒì—… ì—´ë¦´ ë•Œ ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
    map.on('popupopen', function (e) {
        const popupCopyBtn = e.popup.getElement().querySelector('.popup-copy-btn');
        if (popupCopyBtn) {
            popupCopyBtn.addEventListener('click', function (event) {
                event.preventDefault();
                event.stopPropagation();

                const coords = this.dataset.coords;
                const coordId = this.dataset.id;
                const copyCountEl = this.querySelector('.popup-copy-count');

                // í´ë¦½ë³´ë“œì— ë³µì‚¬
                navigator.clipboard.writeText(coords).then(function () {
                    showToast('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤<br><small>ì¢‹ì•„ìš”ì™€ ëŒ“ê¸€ì€ ì—…ë¡œë”ë¶„ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤!</small>');
                }).catch(function () {
                    const textarea = document.createElement('textarea');
                    textarea.value = coords;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤<br><small>ì¢‹ì•„ìš”ì™€ ëŒ“ê¸€ì€ ì—…ë¡œë”ë¶„ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤!</small>');
                });

                // ë³µì‚¬ ì¹´ìš´íŠ¸ API í˜¸ì¶œ (30ë¶„ ì œí•œ)
                fetch('/coordinates/' + coordId + '/copy-coords/')
                    .then(response => response.json())
                    .then(data => {
                        if (copyCountEl) {
                            copyCountEl.textContent = data.copy_count;
                        }
                        // ë§ˆì»¤ ë°ì´í„° ì—…ë°ì´íŠ¸
                        allMarkers.forEach(m => {
                            if (m.coordData.id == coordId) {
                                m.coordData.copy_count = data.copy_count;
                            }
                        });
                    })
                    .catch(err => console.log('Copy count update failed'));
            });
        }
    });

    // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ë§ˆì»¤ ê°€ì ¸ì˜¤ê¸°
    function getVisibleMarkers() {
        const bounds = map.getBounds();
        const checkedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
            .map(cb => cb.value);

        return allMarkers.filter(function (marker) {
            const coord = marker.coordData;
            // ì²´í¬ëœ ì¹´í…Œê³ ë¦¬ì¸ì§€ + í™”ë©´ ë²”ìœ„ ì•ˆì— ìˆëŠ”ì§€
            return checkedCategories.includes(coord.category) &&
                bounds.contains(marker.getLatLng());
        });
    }

    // ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    function updateList() {
        const visibleMarkers = getVisibleMarkers();
        const count = visibleMarkers.length;

        document.getElementById('visibleCount').textContent = count;
        document.getElementById('sidebarCount').textContent = count;

        const listContent = document.getElementById('listContent');

        if (count === 0) {
            listContent.innerHTML = '<div class="list-empty">í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = '';
        visibleMarkers.forEach(function (marker) {
            const coord = marker.coordData;
            html += '<div class="list-item" data-lat="' + coord.lat + '" data-lng="' + coord.lng + '" data-id="' + coord.id + '">';

            if (coord.image) {
                html += '<img src="' + coord.image + '" class="list-item-image" alt="">';
            } else {
                html += '<div class="list-item-placeholder">' + (categoryIcons[coord.category] || 'ğŸ“') + '</div>';
            }

            html += '<div class="list-item-info">';
            html += '<div class="list-item-title">' + coord.title + '</div>';
            html += '<div class="list-item-meta">' + coord.category_display + ' Â· ' + coord.region_display + '</div>';
            html += '<div class="list-item-stats">';
            html += '<span class="copy-btn" data-id="' + coord.id + '" data-coords="' + coord.lat + ', ' + coord.lng + '" title="ì¢Œí‘œ ë³µì‚¬">ğŸ“‹ <span class="copy-count">' + coord.copy_count + '</span></span>';
            html += ' Â· â¤ï¸ ' + coord.like_count;
            html += '</div>';
            html += '</div></div>';
        });

        listContent.innerHTML = html;

        // ë³µì‚¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        listContent.querySelectorAll('.copy-btn').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.stopPropagation(); // ë¦¬ìŠ¤íŠ¸ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                const coords = this.dataset.coords;
                const coordId = this.dataset.id;
                const copyCountEl = this.querySelector('.copy-count');

                // í´ë¦½ë³´ë“œì— ë³µì‚¬
                navigator.clipboard.writeText(coords).then(function () {
                    showToast('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤<br><small>ì¢‹ì•„ìš”ì™€ ëŒ“ê¸€ì€ ì—…ë¡œë”ë¶„ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤!</small>');
                }).catch(function () {
                    // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°©ë²•
                    const textarea = document.createElement('textarea');
                    textarea.value = coords;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('âœ… ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤<br><small>ì¢‹ì•„ìš”ì™€ ëŒ“ê¸€ì€ ì—…ë¡œë”ë¶„ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤!</small>');
                });

                // ë³µì‚¬ ì¹´ìš´íŠ¸ API í˜¸ì¶œ (30ë¶„ ì œí•œ ì ìš©ë¨)
                fetch('/coordinates/' + coordId + '/copy-coords/')
                    .then(response => response.json())
                    .then(data => {
                        // UI ì—…ë°ì´íŠ¸
                        if (copyCountEl) {
                            copyCountEl.textContent = data.copy_count;
                        }
                        // ë§ˆì»¤ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
                        allMarkers.forEach(m => {
                            if (m.coordData.id == coordId) {
                                m.coordData.copy_count = data.copy_count;
                            }
                        });
                    })
                    .catch(err => console.log('Copy count update failed'));
            });
        });

        // í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
        listContent.querySelectorAll('.list-item').forEach(function (item) {
            item.addEventListener('click', function () {
                const lat = parseFloat(this.dataset.lat);
                const lng = parseFloat(this.dataset.lng);

                // í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
                map.setView([lat, lng], 15);

                // í•´ë‹¹ ë§ˆì»¤ íŒì—… ì—´ê¸°
                allMarkers.forEach(function (m) {
                    if (m.coordData.lat === lat && m.coordData.lng === lng) {
                        setTimeout(function () {
                            m.openPopup();
                        }, 500);
                    }
                });
            });
        });
    }

    // ì§€ë„ ì´ë™/ì¤Œ ì‹œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    map.on('moveend', updateList);
    map.on('zoomend', updateList);

    // ì´ˆê¸° ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    setTimeout(updateList, 500);

    // ì¹´í…Œê³ ë¦¬ í•„í„°
    document.querySelectorAll('.category-filter').forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
            const checkedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                .map(cb => cb.value);

            markerCluster.clearLayers();

            allMarkers.forEach(function (marker) {
                if (checkedCategories.includes(marker.coordData.category)) {
                    markerCluster.addLayer(marker);
                }
            });

            updateList();
        });
    });

    // ë¦¬ìŠ¤íŠ¸ í† ê¸€
    const listSidebar = document.getElementById('listSidebar');
    const listToggle = document.getElementById('listToggle');
    const listClose = document.getElementById('listClose');
    const mapControls = document.querySelector('.map-controls');

    listToggle.addEventListener('click', function () {
        listSidebar.classList.toggle('open');
        listToggle.classList.toggle('active');
        mapControls.classList.toggle('sidebar-open');
    });

    listClose.addEventListener('click', function () {
        listSidebar.classList.remove('open');
        listToggle.classList.remove('active');
        mapControls.classList.remove('sidebar-open');
    });

    // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
    let myLocationMarker = null;
    let myLocationCircle = null;

    // ë‚´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    function getMyLocation(successCallback, errorCallback) {
        if (!navigator.geolocation) {
            alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            if (errorCallback) errorCallback();
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                successCallback(lat, lng);
            },
            function (error) {
                let msg = 'ìœ„ì¹˜ ì •ë³´ ì˜¤ë¥˜: ';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        msg = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        msg = 'PCì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                        break;
                    case error.TIMEOUT:
                        msg = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        break;
                    default:
                        msg = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }
                alert(msg);
                if (errorCallback) errorCallback();
            },
            { enableHighAccuracy: false, timeout: 15000, maximumAge: 60000 }
        );
    }

    // ë‚´ ìœ„ì¹˜ í‘œì‹œ
    function showMyLocation(lat, lng) {
        // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        if (myLocationMarker) {
            map.removeLayer(myLocationMarker);
        }
        if (myLocationCircle) {
            map.removeLayer(myLocationCircle);
        }

        // íŒŒë€ìƒ‰ ì› (ì •í™•ë„ í‘œì‹œ)
        myLocationCircle = L.circle([lat, lng], {
            color: '#3498db',
            fillColor: '#3498db',
            fillOpacity: 0.2,
            radius: 100
        }).addTo(map);

        // íŒŒë€ìƒ‰ ì  ë§ˆì»¤
        const myIcon = L.divIcon({
            className: 'my-location-marker',
            html: '<div style="width: 16px; height: 16px; background: #3498db; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
            iconSize: [22, 22],
            iconAnchor: [11, 11]
        });

        myLocationMarker = L.marker([lat, lng], { icon: myIcon })
            .bindPopup('ğŸ“ ë‚´ í˜„ì¬ ìœ„ì¹˜')
            .addTo(map);
    }

    // ë‚´ ìœ„ì¹˜ë¡œ ì´ë™ ë²„íŠ¼
    document.getElementById('myLocationBtn').addEventListener('click', function () {
        this.textContent = 'ğŸ“ ì°¾ëŠ” ì¤‘...';
        const btn = this;

        getMyLocation(
            function (lat, lng) {
                showMyLocation(lat, lng);
                map.setView([lat, lng], 14);
                btn.textContent = 'ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ';
            },
            function () {
                // ì—ëŸ¬ ì‹œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
                btn.textContent = 'ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ';
            }
        );
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚´ ìœ„ì¹˜ ìë™ í‘œì‹œ (ì„ íƒì )
    // getMyLocation(showMyLocation);

    // ========================================
    // ì§€ë„ ê²€ìƒ‰ ê¸°ëŠ¥ (Nominatim)
    // ========================================
    const mapViewSearchInput = document.getElementById('mapViewSearchInput');
    const mapViewSearchBtn = document.getElementById('mapViewSearchBtn');
    const mapViewSearchResults = document.getElementById('mapViewSearchResults');
    let searchMarker = null;

    if (mapViewSearchBtn) {
        mapViewSearchBtn.addEventListener('click', performMapViewSearch);
    }

    if (mapViewSearchInput) {
        mapViewSearchInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performMapViewSearch();
            }
        });

        // ì™¸ë¶€ í´ë¦­ ì‹œ ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
        document.addEventListener('click', function (e) {
            if (!mapViewSearchResults.contains(e.target) &&
                !mapViewSearchInput.contains(e.target) &&
                !mapViewSearchBtn.contains(e.target)) {
                mapViewSearchResults.classList.remove('active');
            }
        });
    }

    function performMapViewSearch() {
        const query = mapViewSearchInput.value.trim();
        if (!query) return;

        // ë¡œë”© í‘œì‹œ
        mapViewSearchResults.innerHTML = '<div class="map-view-loading">ğŸ” ê²€ìƒ‰ ì¤‘...</div>';
        mapViewSearchResults.classList.add('active');
        mapViewSearchBtn.disabled = true;

        // Nominatim API í˜¸ì¶œ (í•œêµ­ ìš°ì„ )
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=kr&accept-language=ko`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    // í•œêµ­ ê²°ê³¼ ì—†ìœ¼ë©´ ì „ì²´ ê²€ìƒ‰
                    return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=ko`)
                        .then(response => response.json());
                }
                return data;
            })
            .then(data => {
                mapViewSearchBtn.disabled = false;

                if (data.length === 0) {
                    mapViewSearchResults.innerHTML = '<div class="map-view-no-results">ğŸ˜¢ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }

                // ê²°ê³¼ í‘œì‹œ
                mapViewSearchResults.innerHTML = data.map(item => `
                    <div class="map-view-result-item" data-lat="${item.lat}" data-lon="${item.lon}">
                        <div class="map-view-result-name">${item.display_name.split(',')[0]}</div>
                        <div class="map-view-result-address">${item.display_name}</div>
                    </div>
                `).join('');

                // ê²°ê³¼ í´ë¦­ ì´ë²¤íŠ¸
                mapViewSearchResults.querySelectorAll('.map-view-result-item').forEach(item => {
                    item.addEventListener('click', function () {
                        const lat = parseFloat(this.dataset.lat);
                        const lon = parseFloat(this.dataset.lon);

                        // ì§€ë„ ì´ë™
                        map.setView([lat, lon], 16);

                        // ê¸°ì¡´ ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                        }

                        // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                        const searchIcon = L.divIcon({
                            className: 'search-location-marker',
                            html: '<div style="font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">ğŸ”</div>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 32]
                        });

                        searchMarker = L.marker([lat, lon], { icon: searchIcon })
                            .bindPopup('ğŸ” ê²€ìƒ‰ ìœ„ì¹˜: ' + this.querySelector('.map-view-result-name').textContent)
                            .addTo(map)
                            .openPopup();

                        // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
                        mapViewSearchResults.classList.remove('active');
                        mapViewSearchInput.value = '';

                        showToast('ğŸ“ ê²€ìƒ‰ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤!');
                    });
                });
            })
            .catch(error => {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                mapViewSearchBtn.disabled = false;
                mapViewSearchResults.innerHTML = '<div class="map-view-no-results">âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            });
    }
</script>
{% endblock %}