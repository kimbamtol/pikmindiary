{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load translate_content %}

{% block title %}{{ coordinate|translate_field:"title" }} - {% trans "í”¼í¬ë¯¼ ë‹¤ì´ì–´ë¦¬" %}{% endblock %}

{% block content %}
<div class="container">
    <div class="detail-page">
        <!-- ë’¤ë¡œê°€ê¸° -->
        <a href="{% url 'coordinates:list' %}" class="back-link">â† {% trans "ëª©ë¡ìœ¼ë¡œ" %}</a>

        <!-- ë©”ì¸ ì¹´ë“œ -->
        <div class="detail-card">
            <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
            <div class="detail-images">
                {% if images %}
                <div class="image-main">
                    <img src="{{ images.0.image.url }}" alt="{{ coordinate|translate_field:"title" }}" id="mainImage">
                </div>
                {% if images.count > 1 %}
                <div class="image-thumbs">
                    {% for img in images %}
                    <img src="{{ img.image.url }}" alt="ì¸ë„¤ì¼ {{ forloop.counter }}"
                        onclick="document.getElementById('mainImage').src='{{ img.image.url }}'"
                        class="{% if forloop.first %}active{% endif %}">
                    {% endfor %}
                </div>
                {% endif %}
                {% else %}
                <div class="image-placeholder">ğŸ—ºï¸ {% trans "ì´ë¯¸ì§€ ì—†ìŒ" %}</div>
                {% endif %}
            </div>

            <!-- ì •ë³´ -->
            <div class="detail-info">
                <div class="detail-header">
                    <span class="badge badge-primary">{{ coordinate.get_category_display }}</span>
                    {% if coordinate.status == 'PENDING' %}
                    <span class="badge badge-pending">{% trans "ìŠ¹ì¸ ëŒ€ê¸°" %}</span>
                    {% endif %}
                </div>

                <h1 class="detail-title">{{ coordinate|translate_field:"title" }}</h1>

                <div class="detail-meta">
                    <span>{% trans "ì‘ì„±ì" %}: {% if coordinate.author %}<a href="{% url 'accounts:user_profile' user_id=coordinate.author.pk %}" class="author-link"><strong>{{ coordinate.author.nickname }}</strong></a>{% else %}<strong>{% trans "ìµëª…" %}</strong>{% endif %}</span>
                    <span>{{ coordinate.created_at|date:"Y.m.d H:i" }}</span>
                </div>

                <!-- ì¢Œí‘œ -->
                <div class="coords-box">
                    <div class="coords-value">
                        <span class="coords-label">ğŸ“ {% trans "ì¢Œí‘œ" %}</span>
                        <code id="coordsText">{{ coordinate.latitude }}, {{ coordinate.longitude }}</code>
                    </div>
                    <button class="btn btn-primary" onclick="copyCoords({{ coordinate.pk }})">
                        ğŸ“‹ {% trans "ë³µì‚¬" %}
                    </button>
                </div>

                <!-- ì„¤ëª… -->
                {% if coordinate.description %}
                <div class="detail-description">
                    <h3>{% trans "ì„¤ëª…" %}</h3>
                    <p>{{ coordinate|translate_field:"description"|linebreaks }}</p>
                </div>
                {% endif %}

                <!-- ìƒí˜¸ì‘ìš© ë²„íŠ¼ -->
                <div class="interaction-buttons">
                    {% if user.is_authenticated and user == coordinate.author %}
                    <!-- ë³¸ì¸ ê¸€ -->
                    <span class="btn-interaction disabled">ğŸ¤ {{ coordinate.like_count }}</span>
                    <button class="btn-interaction {% if user_bookmarked %}active{% endif %}"
                        onclick="toggleBookmark({{ coordinate.pk }}, this)">
                        <span class="bookmark-icon">{% if user_bookmarked %}â­{% else %}â˜†{% endif %}</span>
                        <span>{% trans "ë¶ë§ˆí¬" %}</span>
                    </button>
                    {% else %}
                    <!-- ë‹¤ë¥¸ ì‚¬ëŒ ê¸€ (ë¹„íšŒì› í¬í•¨) -->
                    <button class="btn-interaction {% if user_liked %}active{% endif %}"
                        onclick="toggleLike({{ coordinate.pk }}, this)">
                        <span class="like-icon">{% if user_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                        <span class="like-count">{{ coordinate.like_count }}</span>
                    </button>
                    {% if user.is_authenticated %}
                    <button class="btn-interaction {% if user_bookmarked %}active{% endif %}"
                        onclick="toggleBookmark({{ coordinate.pk }}, this)">
                        <span class="bookmark-icon">{% if user_bookmarked %}â­{% else %}â˜†{% endif %}</span>
                        <span>{% trans "ë¶ë§ˆí¬" %}</span>
                    </button>
                    {% endif %}
                    {% endif %}

                    <a href="{% url 'reports:report_coordinate' coordinate_id=coordinate.pk %}"
                        class="btn-interaction btn-report">
                        ğŸš¨ {% trans "ì‹ ê³ " %}
                    </a>
                </div>

                <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ì‘ì„±ì, ê´€ë¦¬ì, ë˜ëŠ” ë¹„íšŒì› ê¸€) -->
                {% if user.is_authenticated and user == coordinate.author or user.is_staff or coordinate.guest_password %}
                <div class="owner-actions">
                    <a href="{% url 'coordinates:edit' pk=coordinate.pk %}" class="btn btn-outline">{% trans "ìˆ˜ì •" %}</a>
                    <a href="{% url 'coordinates:delete' pk=coordinate.pk %}" class="btn btn-danger-text">{% trans "ì‚­ì œ" %}</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <div class="comments-section">
            <h2>ğŸ’¬ ëŒ“ê¸€ ({{ coordinate.comment_count }})</h2>

            <!-- ëŒ“ê¸€ ì‘ì„± -->
            <form action="{% url 'comments:create' coordinate_id=coordinate.pk %}" method="post" enctype="multipart/form-data" class="comment-form">
                {% csrf_token %}

                {% if not user.is_authenticated %}
                <div class="guest-fields">
                    <input type="text" name="guest_nickname" placeholder="{% trans "ë‹‰ë„¤ì„" %}" class="form-control" required>
                    <input type="password" name="guest_password" placeholder="{% trans "ë¹„ë°€ë²ˆí˜¸ (ìˆ˜ì •/ì‚­ì œìš©)" %}" class="form-control"
                        required>
                </div>
                {% endif %}

                <div class="comment-input">
                    <textarea name="content" placeholder="{% trans "ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... (ì‚¬ì§„ë§Œ ì˜¬ë¦´ ê²½ìš° ë¹„ì›Œë‘¬ë„ ë©ë‹ˆë‹¤)" %}" class="form-control"></textarea>
                    <button type="submit" class="btn btn-primary">{% trans "ë“±ë¡" %}</button>
                </div>

                <!-- ì‚¬ì§„ ì²¨ë¶€ -->
                <div class="photo-upload-section">
                    <label for="photo-input" class="photo-upload-btn">
                        ğŸ“· {% trans "ì—½ì„œ ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)" %}
                    </label>
                    <input
                        type="file"
                        id="photo-input"
                        name="photo"
                        accept="image/jpeg,image/png,image/webp"
                        style="display: none;"
                        onchange="previewPhoto(this)"
                    >

                    <!-- ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="photo-preview" style="display: none;">
                        <img id="preview-image" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                        <button type="button" id="remove-photo" onclick="removePhoto()">âœ• ì œê±°</button>
                    </div>
                </div>
            </form>

            <!-- ëŒ“ê¸€ ì •ë ¬ -->
            <div class="comment-sort">
                <a href="?sort=likes" class="sort-option {% if comment_sort == 'likes' %}active{% endif %}">â¤ï¸ {% trans "ì¢‹ì•„ìš”ìˆœ" %}</a>
                <a href="?sort=newest" class="sort-option {% if comment_sort == 'newest' %}active{% endif %}">ğŸ†• {% trans "ìµœì‹ ìˆœ" %}</a>
                <a href="?sort=oldest" class="sort-option {% if comment_sort == 'oldest' %}active{% endif %}">ğŸ• {% trans "ì˜¤ë˜ëœìˆœ" %}</a>
            </div>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <div class="comment-list" id="commentList">
                {% for comment in comments %}
                <div class="comment {% if comment.is_deleted %}deleted{% endif %} {% if comment.has_photo %}comment-with-photo{% endif %}">
                    <div class="comment-header">
                        {% if comment.author %}
                        <a href="{% url 'accounts:user_profile' user_id=comment.author.pk %}" class="author-badge {{ comment.author.get_badge_class }}">
                            {% if comment.author.profile_emoji %}
                            <span class="profile-emoji">{{ comment.author.profile_emoji }}</span>
                            {% endif %}
                            <span class="author-name"><strong>{{ comment.author.nickname }}</strong></span>
                            {% if comment.author.special_title %}
                            <span class="special-title-tag">{{ comment.author.get_special_title_display }}</span>
                            {% endif %}
                        </a>
                        {% else %}
                        <strong>{{ comment.display_name }}</strong>
                        {% endif %}
                        <span class="comment-date">{{ comment.created_at|date:"m/d H:i" }}</span>
                    </div>
                    <div class="comment-content">
                        {% if comment.content %}
                            {{ comment|translate_field:"content"|linebreaks }}
                        {% endif %}

                        {% if comment.has_photo %}
                        <div class="comment-photo">
                            <img
                                src="{{ comment.photo.url }}"
                                alt="ëŒ“ê¸€ ì‚¬ì§„"
                                class="photo-thumbnail"
                                onclick="openPhotoModal('{{ comment.photo.url }}')"
                                loading="lazy"
                            >
                        </div>
                        {% endif %}
                    </div>

                    {% if not comment.is_deleted %}
                    <div class="comment-actions">
                        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                        <button
                            class="btn-text comment-like-btn {% if comment.pk in user_liked_comments %}liked{% endif %}"
                            onclick="toggleCommentLike({{ comment.pk }})"
                            data-comment-id="{{ comment.pk }}"
                            {% if user == comment.author %}disabled title="ë³¸ì¸ ëŒ“ê¸€ì—ëŠ” ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"{% endif %}
                        >
                            <span class="like-icon">{% if comment.pk in user_liked_comments %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                            <span class="like-count">{{ comment.like_count }}</span>
                        </button>

                        <!-- ë‹µê¸€ ë²„íŠ¼ (ë¹„íšŒì›ë„ ê°€ëŠ¥) -->
                        <button class="btn-text reply-btn" onclick="toggleReplyForm({{ comment.pk }})">{% trans "ë‹µê¸€" %}</button>

                        {% if user == comment.author or user.is_staff %}
                        <!-- ë¡œê·¸ì¸ ì‚¬ìš©ì: ë°”ë¡œ ì‚­ì œ ê°€ëŠ¥ -->
                        <form action="{% url 'comments:delete' pk=comment.pk %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-text" onclick="return confirm('{% trans "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" %}')">{% trans "ì‚­ì œ" %}</button>
                        </form>
                        {% elif comment.guest_password %}
                        <!-- ë¹„íšŒì› ëŒ“ê¸€: ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì‚­ì œ -->
                        <button class="btn-text" onclick="toggleDeleteForm({{ comment.pk }})">{% trans "ì‚­ì œ" %}</button>
                        <form action="{% url 'comments:delete' pk=comment.pk %}" method="post"
                            class="delete-form hidden" id="deleteForm{{ comment.pk }}">
                            {% csrf_token %}
                            <div class="delete-password-input">
                                <input type="password" name="password" placeholder="{% trans "ë¹„ë°€ë²ˆí˜¸" %}" class="form-control" required>
                                <button type="submit" class="btn btn-sm">{% trans "í™•ì¸" %}</button>
                            </div>
                        </form>
                        {% endif %}
                    </div>

                    <!-- ë‹µê¸€ í¼ -->
                    <form action="{% url 'comments:reply' pk=comment.pk %}" method="post" enctype="multipart/form-data" class="reply-form hidden"
                        id="replyForm{{ comment.pk }}">
                        {% csrf_token %}
                        {% if not user.is_authenticated %}
                        <div class="guest-fields">
                            <input type="text" name="guest_nickname" placeholder="{% trans "ë‹‰ë„¤ì„" %}" class="form-control" required>
                            <input type="password" name="guest_password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="form-control"
                                required>
                        </div>
                        {% endif %}
                        <div class="comment-input">
                            <textarea name="content" placeholder="{% trans "ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... (ì‚¬ì§„ë§Œ ì˜¬ë¦´ ê²½ìš° ë¹„ì›Œë‘¬ë„ ë©ë‹ˆë‹¤)" %}" class="form-control"></textarea>
                            <button type="submit" class="btn btn-primary btn-sm">{% trans "ë“±ë¡" %}</button>
                        </div>

                        <!-- ì‚¬ì§„ ì²¨ë¶€ -->
                        <div class="photo-upload-section">
                            <label for="photo-input-reply-{{ comment.pk }}" class="photo-upload-btn">
                                ğŸ“· {% trans "ì—½ì„œ ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)" %}
                            </label>
                            <input
                                type="file"
                                id="photo-input-reply-{{ comment.pk }}"
                                name="photo"
                                accept="image/jpeg,image/png,image/webp"
                                style="display: none;"
                                onchange="previewReplyPhoto(this, {{ comment.pk }})"
                            >

                            <!-- ë¯¸ë¦¬ë³´ê¸° -->
                            <div id="photo-preview-reply-{{ comment.pk }}" style="display: none;">
                                <img id="preview-image-reply-{{ comment.pk }}" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
                                <button type="button" onclick="removeReplyPhoto({{ comment.pk }})">âœ• ì œê±°</button>
                            </div>
                        </div>
                    </form>
                    {% endif %}

                    <!-- ëŒ€ëŒ“ê¸€ -->
                    {% for reply in comment.replies.all %}
                    {% if not reply.is_deleted or reply.is_deleted %}
                    <div class="comment reply {% if reply.has_photo %}comment-with-photo{% endif %}">
                        <div class="comment-header">
                            {% if reply.author %}
                            <a href="{% url 'accounts:user_profile' user_id=reply.author.pk %}" class="author-badge {{ reply.author.get_badge_class }}">
                                {% if reply.author.profile_emoji %}
                                <span class="profile-emoji">{{ reply.author.profile_emoji }}</span>
                                {% endif %}
                                <span class="author-name"><strong>{{ reply.author.nickname }}</strong></span>
                                {% if reply.author.special_title %}
                                <span class="special-title-tag">{{ reply.author.get_special_title_display }}</span>
                                {% endif %}
                            </a>
                            {% else %}
                            <strong>{{ reply.display_name }}</strong>
                            {% endif %}
                            <span class="comment-date">{{ reply.created_at|date:"m/d H:i" }}</span>
                        </div>
                        <div class="comment-content">
                            {% if reply.content %}
                                {{ reply.content|linebreaks }}
                            {% endif %}

                            {% if reply.has_photo %}
                            <div class="comment-photo">
                                <img
                                    src="{{ reply.photo.url }}"
                                    alt="ëŒ“ê¸€ ì‚¬ì§„"
                                    class="photo-thumbnail"
                                    onclick="openPhotoModal('{{ reply.photo.url }}')"
                                    loading="lazy"
                                >
                            </div>
                            {% endif %}
                        </div>

                        {% if not reply.is_deleted %}
                        <div class="comment-actions">
                            <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
                            <button
                                class="btn-text comment-like-btn {% if reply.pk in user_liked_comments %}liked{% endif %}"
                                onclick="toggleCommentLike({{ reply.pk }})"
                                data-comment-id="{{ reply.pk }}"
                                {% if user == reply.author %}disabled title="ë³¸ì¸ ëŒ“ê¸€ì—ëŠ” ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"{% endif %}
                            >
                                <span class="like-icon">{% if reply.pk in user_liked_comments %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                                <span class="like-count">{{ reply.like_count }}</span>
                            </button>

                            {% if user == reply.author or user.is_staff %}
                            <!-- ë¡œê·¸ì¸ ì‚¬ìš©ì: ë°”ë¡œ ì‚­ì œ ê°€ëŠ¥ -->
                            <form action="{% url 'comments:delete' pk=reply.pk %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn-text" onclick="return confirm('{% trans "ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" %}')">{% trans "ì‚­ì œ" %}</button>
                            </form>
                            {% elif reply.guest_password %}
                            <!-- ë¹„íšŒì› ëŒ“ê¸€: ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì‚­ì œ -->
                            <button class="btn-text" onclick="toggleDeleteForm({{ reply.pk }})">ì‚­ì œ</button>
                            <form action="{% url 'comments:delete' pk=reply.pk %}" method="post"
                                class="delete-form hidden" id="deleteForm{{ reply.pk }}">
                                {% csrf_token %}
                                <div class="delete-password-input">
                                    <input type="password" name="password" placeholder="{% trans "ë¹„ë°€ë²ˆí˜¸" %}" class="form-control" required>
                                    <button type="submit" class="btn btn-sm">{% trans "í™•ì¸" %}</button>
                                </div>
                            </form>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% empty %}
                <p class="no-comments">{% trans "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!" %}</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    .detail-page {
        max-width: 900px;
        margin: var(--spacing-xl) auto;
    }

    .back-link {
        display: inline-block;
        margin-bottom: var(--spacing-md);
        color: var(--text-secondary);
    }

    .detail-card {
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }

    .detail-images {
        background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    }

    .image-main {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
        max-height: 70vh;
        overflow: hidden;
    }

    .image-main img {
        max-width: 100%;
        max-height: 70vh;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: var(--radius-md);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .image-thumbs {
        display: flex;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm);
        overflow-x: auto;
    }

    .image-thumbs img {
        width: 80px;
        height: 60px;
        object-fit: cover;
        border-radius: var(--radius-sm);
        cursor: pointer;
        opacity: 0.6;
        transition: opacity var(--transition-fast);
    }

    .image-thumbs img:hover,
    .image-thumbs img.active {
        opacity: 1;
    }

    .image-placeholder {
        aspect-ratio: 16/9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: var(--text-light);
    }

    .detail-info {
        padding: var(--spacing-xl);
    }

    .detail-header {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
    }

    .detail-title {
        font-size: 1.8rem;
        margin-bottom: var(--spacing-sm);
    }

    .detail-meta {
        display: flex;
        gap: var(--spacing-lg);
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: var(--spacing-lg);
    }

    .coords-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
    }

    .coords-label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .coords-value code {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
    }

    .detail-description {
        margin-bottom: var(--spacing-lg);
    }

    .detail-description h3 {
        font-size: 1rem;
        margin-bottom: var(--spacing-sm);
    }

    .detail-description p {
        color: var(--text-secondary);
        line-height: 1.8;
    }

    .interaction-buttons {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
    }

    .btn-interaction {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--bg-tertiary);
        border-radius: var(--radius-full);
        background: var(--bg-primary);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-interaction:hover {
        border-color: var(--primary);
    }

    .btn-interaction.active {
        border-color: var(--primary);
        background: var(--primary-light);
    }

    .btn-report {
        color: var(--text-secondary);
    }

    .login-notice {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .validity-section {
        padding: var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        margin-bottom: var(--spacing-lg);
    }

    .owner-actions {
        display: flex;
        gap: var(--spacing-sm);
        padding-top: var(--spacing-lg);
        border-top: 1px solid var(--bg-tertiary);
    }

    /* ëŒ“ê¸€ */
    .comments-section {
        margin-top: var(--spacing-xl);
        padding: var(--spacing-xl);
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-sm);
    }

    .comments-section h2 {
        margin-bottom: var(--spacing-lg);
    }

    .comment-form {
        margin-bottom: var(--spacing-xl);
    }

    .guest-fields {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
    }

    .comment-input {
        display: flex;
        gap: var(--spacing-sm);
    }

    .comment-input textarea {
        flex: 1;
        min-height: 80px;
    }

    .comment {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--bg-tertiary);
    }

    .comment.reply {
        margin-left: var(--spacing-xl);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: none;
        margin-top: var(--spacing-sm);
    }

    .comment.deleted {
        opacity: 0.5;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm);
    }

    .author-link {
        color: var(--text-primary);
    }

    .author-link:hover {
        color: var(--primary);
    }

    a.author-badge {
        text-decoration: none;
        color: inherit;
    }

    a.author-badge:hover {
        opacity: 0.8;
    }

    .comment-date {
        font-size: 0.85rem;
        color: var(--text-light);
    }

    .comment-content {
        color: var(--text-secondary);
        line-height: 1.6;
    }

    .comment-sort {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-sm);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
    }

    .sort-option {
        padding: var(--spacing-xs) var(--spacing-md);
        border-radius: var(--radius-sm);
        text-decoration: none;
        color: var(--text-secondary);
        transition: all 0.2s;
        cursor: pointer;
    }

    .sort-option:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
    }

    .sort-option.active {
        background: var(--primary);
        color: white;
        font-weight: bold;
    }

    .comment-actions {
        margin-top: var(--spacing-sm);
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
    }

    .comment-like-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border: none;
        background: transparent;
        cursor: pointer;
        transition: all 0.2s;
    }

    .comment-like-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .comment-like-btn.liked .like-icon {
        animation: heartbeat 0.3s ease;
    }

    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }

    .reply-form {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
    }

    .reply-form.hidden {
        display: none;
    }

    .no-comments {
        text-align: center;
        color: var(--text-light);
        padding: var(--spacing-xl);
    }

    @media (max-width: 480px) {
        .detail-info {
            padding: var(--spacing-md);
        }

        .coords-box {
            flex-direction: column;
            align-items: stretch;
        }

        .validity-buttons {
            flex-direction: column;
        }

        .guest-fields {
            flex-direction: column;
        }

        .comment-input {
            flex-direction: column;
        }
    }

    /* ì‚¬ì§„ ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
    .comment-with-photo {
        border-left: 3px solid #4CAF50;
    }

    .comment-photo {
        margin-top: var(--spacing-sm);
    }

    .photo-thumbnail {
        max-width: 300px;
        max-height: 300px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .photo-thumbnail:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* ì‚¬ì§„ ì—…ë¡œë“œ ì„¹ì…˜ */
    .photo-upload-section {
        margin-top: var(--spacing-sm);
    }

    .photo-upload-btn {
        display: inline-block;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--bg-secondary);
        border: 1px solid var(--bg-tertiary);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .photo-upload-btn:hover {
        background: var(--bg-tertiary);
        border-color: var(--primary);
    }

    /* ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° */
    #photo-preview,
    [id^="photo-preview-reply-"] {
        position: relative;
        margin-top: var(--spacing-sm);
        display: inline-block;
    }

    #preview-image,
    [id^="preview-image-reply-"] {
        max-width: 200px;
        max-height: 200px;
        border-radius: var(--radius-md);
        border: 2px solid var(--bg-tertiary);
    }

    #remove-photo,
    [id^="photo-preview-reply-"] button {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
    }

    /* ì‚¬ì§„ í™•ëŒ€ ëª¨ë‹¬ */
    .photo-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .photo-modal.active {
        display: flex;
    }

    .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
    }

    .modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        z-index: 10000;
    }

    .modal-close {
        position: absolute;
        top: -40px;
        right: 0;
        background: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 20px;
        cursor: pointer;
        z-index: 10001;
    }

    .modal-image {
        max-width: 100%;
        max-height: 90vh;
        border-radius: var(--radius-md);
    }

    @media (max-width: 768px) {
        .photo-thumbnail {
            max-width: 100%;
        }

        .modal-content {
            max-width: 95%;
            max-height: 95%;
        }

        .modal-image {
            max-height: 80vh;
        }
    }
</style>

<!-- ì‚¬ì§„ í™•ëŒ€ ëª¨ë‹¬ -->
<div id="photoModal" class="photo-modal" onclick="closePhotoModal()">
    <div class="modal-overlay"></div>
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closePhotoModal()">âœ•</button>
        <img id="modalImage" class="modal-image" src="" alt="ì‚¬ì§„ í™•ëŒ€ë³´ê¸°">
    </div>
</div>

<script>
    // ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
    function previewPhoto(input) {
        const file = input.files[0];
        if (!file) return;

        // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            input.value = '';
            return;
        }

        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-image').src = e.target.result;
            document.getElementById('photo-preview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function removePhoto() {
        document.getElementById('photo-input').value = '';
        document.getElementById('photo-preview').style.display = 'none';
    }

    // ë‹µê¸€ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°
    function previewReplyPhoto(input, commentId) {
        const file = input.files[0];
        if (!file) return;

        // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            input.value = '';
            return;
        }

        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-image-reply-' + commentId).src = e.target.result;
            document.getElementById('photo-preview-reply-' + commentId).style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function removeReplyPhoto(commentId) {
        document.getElementById('photo-input-reply-' + commentId).value = '';
        document.getElementById('photo-preview-reply-' + commentId).style.display = 'none';
    }

    // ì‚¬ì§„ ëª¨ë‹¬
    function openPhotoModal(imageUrl) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('photoModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closePhotoModal() {
        document.getElementById('photoModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePhotoModal();
        }
    });

    function toggleReplyForm(commentId) {
        const form = document.getElementById('replyForm' + commentId);
        form.classList.toggle('hidden');
    }

    function toggleDeleteForm(commentId) {
        const form = document.getElementById('deleteForm' + commentId);
        form.classList.toggle('hidden');
    }

    function toggleCommentLike(commentId) {
        const btn = document.querySelector(`.comment-like-btn[data-comment-id="${commentId}"]`);
        if (!btn || btn.disabled) return;

        fetch(`/interactions/comment-like/${commentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            const likeIcon = btn.querySelector('.like-icon');
            const likeCount = btn.querySelector('.like-count');

            if (data.liked) {
                btn.classList.add('liked');
                likeIcon.textContent = 'â¤ï¸';
            } else {
                btn.classList.remove('liked');
                likeIcon.textContent = 'ğŸ¤';
            }

            likeCount.textContent = data.like_count;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function copyCoords(pk) {
        var coordsText = document.getElementById('coordsText');
        if (!coordsText) return;

        var text = coordsText.textContent.trim();
        var copyBtn = document.querySelector('.coords-box .btn-primary');

        function showSuccess() {
            if (copyBtn) {
                copyBtn.innerHTML = 'âœ… ë³µì‚¬ë¨';
                setTimeout(function () {
                    copyBtn.innerHTML = 'ğŸ“‹ ë³µì‚¬';
                }, 2500);
            }

            var toast = document.getElementById('copy-toast');
            if (toast) {
                toast.classList.add('show');
                setTimeout(function () {
                    toast.classList.remove('show');
                }, 2500);
            }

            // ë³µì‚¬ ì¹´ìš´íŠ¸ API í˜¸ì¶œ (30ë¶„ ì œí•œ ì ìš©)
            fetch('/coordinates/' + pk + '/copy-coords/')
                .then(function (r) { return r.json(); })
                .then(function (d) { console.log('Copy count:', d.copy_count); })
                .catch(function () { });
        }

        // iOS/Safari ê°ì§€
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        if (isIOS || isSafari) {
            copyTextForiOS(text, showSuccess);
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(showSuccess).catch(function () {
                copyTextFallback(text, showSuccess);
            });
        } else {
            copyTextFallback(text, showSuccess);
        }
    }

    function copyTextForiOS(text, callback) {
        var input = document.createElement('input');
        input.setAttribute('readonly', 'readonly');
        input.setAttribute('contenteditable', 'true');
        input.style.position = 'fixed';
        input.style.top = '50%';
        input.style.left = '50%';
        input.style.opacity = '0';
        input.style.fontSize = '16px';
        input.value = text;
        document.body.appendChild(input);

        input.focus();
        input.setSelectionRange(0, text.length);

        var success = false;
        try {
            success = document.execCommand('copy');
        } catch (err) {
            success = false;
        }

        document.body.removeChild(input);

        if (success) {
            callback();
        } else {
            alert('ë³µì‚¬ë¨: ' + text);
        }
    }

    function copyTextFallback(text, callback) {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.style.top = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
            document.execCommand('copy');
            callback();
        } catch (err) {
            alert('ë³µì‚¬ë¨: ' + text);
        }

        document.body.removeChild(textarea);
    }
</script>

<div id="copy-toast" class="copy-toast">âœ… {% trans "ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤" %}<br><small>{% trans "ì¢‹ì•„ìš”ì™€ ëŒ“ê¸€ì€ ì—…ë¡œë”ë¶„ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤!" %}</small></div>

<style>
    .copy-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
        text-align: center;
        line-height: 1.6;
    }

    .copy-toast.show {
        opacity: 1;
    }

    .copy-toast small {
        font-size: 0.78rem;
        opacity: 0.85;
    }

    .delete-form {
        margin-top: var(--spacing-sm);
        padding: var(--spacing-sm);
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
    }

    .delete-form.hidden {
        display: none;
    }

    .delete-password-input {
        display: flex;
        gap: var(--spacing-xs);
        align-items: center;
    }

    .delete-password-input input {
        width: 120px;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.85rem;
    }
</style>
{% endblock %}