{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "í”¼í¬ë¯¼ ì¢Œí‘œ ëª©ë¡ - ë²„ì„¯, ëª¨ì¢…, ë¹…í”Œë¼ì›Œ ì¢Œí‘œ ëª¨ìŒ | í”¼í¬ë¯¼ ë‹¤ì´ì–´ë¦¬" %}{% endblock %}
{% block description %}{% trans "í”¼í¬ë¯¼ ë¸”ë£¸ ë²„ì„¯ ì¢Œí‘œ, ëª¨ì¢… ì¢Œí‘œ, ë¹…í”Œë¼ì›Œ ìœ„ì¹˜ë¥¼ í•œëˆˆì—! ìœ ì €ë“¤ì´ ê³µìœ í•œ í”¼í¬ë¯¼ ì—½ì„œ ì¢Œí‘œë¥¼ ê²€ìƒ‰í•˜ê³  ë³µì‚¬í•˜ì„¸ìš”." %}{% endblock %}
{% block og_title %}{% trans "í”¼í¬ë¯¼ ì¢Œí‘œ ëª©ë¡ - í”¼í¬ë¯¼ ë¸”ë£¸ ì¢Œí‘œ ëª¨ìŒ" %}{% endblock %}

{% block content %}
<div class="container">
    <div class="list-header">
        <h1 class="page-title">ğŸ“ {% trans "ì¢Œí‘œ ëª©ë¡" %}</h1>
        <a href="{% url 'coordinates:create' %}" class="btn btn-primary">
            âœï¸ {% trans "ìƒˆ ì¢Œí‘œ ì œë³´" %}
        </a>
    </div>

    <div class="coord-page-layout">
        <!-- ì¢Œì¸¡ ë­í‚¹ ìœ„ì ¯ -->
        <aside class="ranking-sidebar">
            <div class="ranking-widget">
                <h3 class="ranking-widget-title">ğŸ† {% trans "TOP 5 ë­ì»¤" %}</h3>
                {% if ranker_stats %}
                <div class="ranking-widget-list">
                    {% for stat in ranker_stats %}
                    <a href="{% url 'accounts:user_profile' user_id=stat.ranking.user.pk %}"
                        class="ranking-widget-item">
                        <div class="ranker-header">
                            <span class="ranker-rank">
                                {% if stat.ranking.rank == 1 %}ğŸ¥‡
                                {% elif stat.ranking.rank == 2 %}ğŸ¥ˆ
                                {% elif stat.ranking.rank == 3 %}ğŸ¥‰
                                {% else %}{{ stat.ranking.rank }}.
                                {% endif %}
                            </span>
                            <span class="ranker-name">{{ stat.ranking.user.nickname }}</span>
                        </div>
                        <div class="ranker-stats">
                            <span title="ë²„ì„¯">ğŸ„{{ stat.mushroom }}</span>
                            <span title="ë¹…í”Œë¼ì›Œ">ğŸŒ»{{ stat.bigflower }}</span>
                            <span title="ëª¨ì¢…">ğŸŒ±{{ stat.seedling }}</span>
                            <span title="ì´ ê¸€ ìˆ˜">ğŸ“{{ stat.total_posts }}</span>
                            <span class="ranker-score">{{ stat.ranking.score }}{% trans "ì " %}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                <a href="{% url 'rankings:list' %}" class="ranking-widget-more">{% trans "ë”ë³´ê¸°" %} â†’</a>
                {% else %}
                <p class="ranking-widget-empty">{% trans "ì•„ì§ ë­í‚¹ì´ ì—†ì–´ìš”" %}</p>
                {% endif %}
            </div>

            <!-- ê´€ë¦¬ì ê³µì§€ (ê°ì‚¬ ë©”ì‹œì§€ ë“±) -->
            {% if site_notice %}
            <div class="notice-widget">
                {% if site_notice.title %}
                <h4 class="notice-widget-title">{{ site_notice.title }}</h4>
                {% endif %}
                <div class="notice-widget-content">{{ site_notice.content|linebreaks }}</div>
            </div>
            {% endif %}
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="coord-main-content">
            <!-- ê²€ìƒ‰ & í•„í„° -->
            <div class="filter-bar">
                <form method="get" class="filter-form">
                    <div class="search-box">
                        <input type="text" name="q" value="{{ query }}" placeholder="{% trans "ì œëª©, ì—½ì„œì´ë¦„, ë‹‰ë„¤ì„ ê²€ìƒ‰..." %}"
                            class="form-control">
                        <button type="submit" class="btn btn-primary">ğŸ”</button>
                    </div>

                    <div class="filter-options">
                        <select name="category" class="form-control" onchange="this.form.submit()">
                            <option value="">{% trans "ì „ì²´ ì¹´í…Œê³ ë¦¬" %}</option>
                            {% for value, label in categories %}
                            <option value="{{ value }}" {% if category==value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>

                        <select name="region" class="form-control" onchange="this.form.submit()">
                            <option value="">{% trans "ì „ì²´ ì§€ì—­" %}</option>
                            {% for value, label in regions %}
                            <option value="{{ value }}" {% if region_filter==value %}selected{% endif %}>{{ label }}
                            </option>
                            {% endfor %}
                        </select>

                        <select name="sort" class="form-control" onchange="this.form.submit()">
                            <option value="latest" {% if sort=="latest" %}selected{% endif %}>{% trans "ìµœì‹ ìˆœ" %}</option>
                            <option value="copies" {% if sort=="copies" %}selected{% endif %}>{% trans "ë³µì‚¬ìˆœ" %}</option>
                            <option value="likes" {% if sort=="likes" %}selected{% endif %}>{% trans "ì¢‹ì•„ìš”ìˆœ" %}</option>
                            <option value="bookmarks" {% if sort=="bookmarks" %}selected{% endif %}>{% trans "ë¶ë§ˆí¬ìˆœ" %}</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- ì¢Œí‘œ ëª©ë¡ -->
            {% if coords %}
            <div class="coord-grid grid grid-3">
                {% for coord in coords %}
                <article class="card coord-card">
                    <a href="{% url 'coordinates:detail' pk=coord.pk %}">
                        <div class="coord-card-image">
                            {% if coord.images.first %}
                            <img src="{{ coord.images.first.image.url }}" alt="{{ coord.title }}">
                            {% else %}
                            <div class="coord-card-placeholder">ğŸ—ºï¸</div>
                            {% endif %}
                            <span class="badge badge-primary coord-card-category">
                                {{ coord.get_category_display }}
                            </span>
                            {% if coord.is_outdated %}
                            <span class="badge badge-warning coord-card-badge">{% trans "ì˜¤ë˜ë¨" %}</span>
                            {% endif %}
                        </div>

                        <div class="coord-card-content">
                            <h3 class="coord-card-title">{{ coord.title }}</h3>
                            {% if coord.postcard_name %}
                            <div class="coord-card-postcard">ğŸ·ï¸ {{ coord.postcard_name }}</div>
                            {% endif %}
                            <div class="coord-card-meta">
                                <span>ğŸ“ {{ coord.latitude }}, {{ coord.longitude }}</span>
                                <span class="coord-region">{{ coord.get_region_display }}</span>
                            </div>
                            <div class="coord-card-meta">
                                <span>{{ coord.author.nickname|default:_("ìµëª…") }}</span>
                            </div>
                        </div>
                    </a>

                    <!-- âš ï¸ WARNING: DO NOT MODIFY THIS SECTION âš ï¸ 
                         The template variables below MUST stay on ONE LINE.
                         DO NOT split {{ coord.copy_count }} across lines!
                         Django template syntax requires variables to be on single lines.
                    -->
                    <div class="coord-card-stats">
                        <button type="button" class="copy-btn" data-coords="{{ coord.latitude }}, {{ coord.longitude }}"
                            data-pk="{{ coord.pk }}" title="ì¢Œí‘œ ë³µì‚¬">ğŸ“‹ <span class="copy-count">{{ coord.copy_count
                                }}</span></button>
                        <span class="coord-stat">ğŸ‘ï¸ {{ coord.view_count }}</span>
                        <span class="coord-stat">â¤ï¸ {{ coord.like_count }}</span>
                        <span class="coord-stat">â­ {{ coord.bookmark_count }}</span>
                        <span class="coord-stat">ğŸ’¬ {{ coord.comment_count }}</span>
                    </div>
                </article>
                {% endfor %}
            </div>


            <!-- ë¬´í•œ ìŠ¤í¬ë¡¤ ë¡œë”© í‘œì‹œ -->
            {% if has_next %}
            <div id="scroll-sentinel" class="scroll-loading">
                <div class="loading-spinner"></div>
                <span>{% trans "ë¡œë”© ì¤‘..." %}</span>
            </div>
            {% endif %}

            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ—ºï¸</div>
                <h2 class="empty-state-title">{% trans "ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤" %}</h2>
                <p class="empty-state-desc">
                    {% if query or category %}
                    {% trans "ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤." %}
                    {% else %}
                    {% trans "ì²« ë²ˆì§¸ ì¢Œí‘œë¥¼ ì œë³´í•´ì£¼ì„¸ìš”!" %}
                    {% endif %}
                </p>
                <a href="{% url 'coordinates:create' %}" class="btn btn-primary">{% trans "ìƒˆ ì¢Œí‘œ ì œë³´" %}</a>
            </div>
            {% endif %}
        </main>
    </div>
</div>

<style>
    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: var(--spacing-xl) 0;
    }

    .page-title {
        font-size: 1.8rem;
        margin: 0;
    }

    /* 2ì—´ ë ˆì´ì•„ì›ƒ */
    .coord-page-layout {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: var(--spacing-xl);
        align-items: start;
    }

    /* ë­í‚¹ ì‚¬ì´ë“œë°” */
    .ranking-sidebar {
        position: sticky;
        top: 80px;
    }

    .ranking-widget {
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-sm);
        padding: var(--spacing-md);
        overflow: hidden;
    }

    .ranking-widget-title {
        font-size: 1rem;
        font-weight: 700;
        text-align: center;
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid var(--bg-tertiary);
        margin-bottom: var(--spacing-sm);
    }

    .ranking-widget-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .ranking-widget-item {
        display: block;
        padding: var(--spacing-sm);
        border-radius: var(--radius-md);
        transition: background var(--transition-fast);
        border-bottom: 1px solid var(--bg-secondary);
    }

    .ranking-widget-item:last-child {
        border-bottom: none;
    }

    .ranking-widget-item:hover {
        background: var(--bg-secondary);
    }

    .ranker-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-bottom: 4px;
    }

    .ranker-rank {
        font-weight: 700;
        font-size: 1rem;
    }

    .ranker-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .ranker-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .ranker-stats span {
        white-space: nowrap;
    }

    .ranker-score {
        font-weight: 700;
        color: var(--primary);
    }

    .ranking-widget-more {
        display: block;
        text-align: center;
        padding: var(--spacing-sm);
        font-size: 0.85rem;
        color: var(--primary);
        font-weight: 600;
        margin-top: var(--spacing-sm);
        border-top: 1px solid var(--bg-tertiary);
    }

    .ranking-widget-more:hover {
        color: var(--primary-dark);
    }

    .ranking-widget-empty {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.85rem;
        padding: var(--spacing-md);
    }

    /* ê³µì§€ ìœ„ì ¯ (ê°ì‚¬ ë©”ì‹œì§€ ë“±) */
    .notice-widget {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
        box-shadow: var(--shadow-sm);
    }

    .notice-widget-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
    }

    .notice-widget-content {
        font-size: 0.85rem;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    .notice-widget-content p {
        margin: 0;
    }

    /* ë©”ì¸ ì»¨í…ì¸  */
    .coord-main-content {
        min-width: 0;
    }

    .filter-bar {
        margin-bottom: var(--spacing-xl);
        padding: var(--spacing-md);
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
    }

    .filter-form {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .search-box {
        display: flex;
        gap: var(--spacing-sm);
    }

    .search-box .form-control {
        flex: 1;
    }

    .filter-options {
        display: flex;
        gap: var(--spacing-md);
    }

    .filter-options .form-control {
        flex: 1;
    }

    .coord-card-placeholder {
        width: 100%;
        aspect-ratio: 16/9;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        font-size: 3rem;
    }

    .coord-card-postcard {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    .coord-card-badge {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
    }

    @media (max-width: 992px) {
        .coord-page-layout {
            grid-template-columns: 1fr;
        }

        .ranking-sidebar {
            position: static;
        }

        .ranking-widget {
            margin-bottom: var(--spacing-md);
        }

        .ranking-widget-list {
            flex-direction: row;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .ranking-widget-item {
            flex: 1;
            min-width: 150px;
            border-bottom: none;
            background: var(--bg-secondary);
        }
    }

    @media (max-width: 768px) {
        .list-header {
            flex-direction: column;
            gap: var(--spacing-md);
            text-align: center;
        }

        .filter-options {
            flex-direction: column;
        }

        .filter-options .form-control {
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--text-primary);
        }
    }

    .coord-copy-row {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .coord-card-stats {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
        color: var(--text-secondary);
        padding: 8px 12px;
        border-top: 1px solid var(--bg-tertiary);
    }

    .coord-stat {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .copy-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        font-size: 1rem;
        color: var(--text-secondary);
        transition: all 0.2s;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }

    .copy-btn:hover {
        color: var(--primary);
    }

    .copy-btn:active {
        transform: scale(0.95);
    }

    .copy-btn.copied {
        color: #4CAF50;
    }

    .copy-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
        text-align: center;
        line-height: 1.6;
    }

    .copy-toast small {
        font-size: 0.78rem;
        opacity: 0.85;
    }

    .copy-toast.show {
        opacity: 1;
    }

    /* ë¬´í•œ ìŠ¤í¬ë¡¤ ë¡œë”© í‘œì‹œ */
    .scroll-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 24px;
        color: var(--text-secondary);
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--bg-tertiary);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .scroll-loading.hidden {
        display: none;
    }
</style>

<div id="copy-toast" class="copy-toast">âœ… {% trans "ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤" %}<br><small>{% trans "ì¢‹ì•„ìš”ì™€ ëŒ“ê¸€ì€ ì—…ë¡œë”ë¶„ì—ê²Œ í° í˜ì´ ë©ë‹ˆë‹¤!" %}</small></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Attach event listeners to all copy buttons
        var copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                var coords = this.getAttribute('data-coords');
                if (coords) {
                    handleCopy(coords, this);
                }
            });

            // Also handle touch for iOS
            btn.addEventListener('touchend', function (e) {
                e.preventDefault();
                e.stopPropagation();
                var coords = this.getAttribute('data-coords');
                if (coords) {
                    handleCopy(coords, this);
                }
            });
        });
    });

    function handleCopy(coords, btn) {
        var pk = btn.getAttribute('data-pk');
        var copyCountSpan = btn.querySelector('.copy-count');
        var originalHTML = btn.innerHTML;

        function showSuccess(newCount) {
            btn.innerHTML = 'âœ… ' + (newCount !== undefined ? newCount : (copyCountSpan ? copyCountSpan.textContent : ''));
            btn.classList.add('copied');

            var toast = document.getElementById('copy-toast');
            if (toast) {
                toast.classList.add('show');
            }

            setTimeout(function () {
                btn.innerHTML = 'ğŸ“‹ <span class="copy-count">' + (newCount !== undefined ? newCount : (copyCountSpan ? copyCountSpan.textContent : '')) + '</span>';
                btn.classList.remove('copied');
                if (toast) {
                    toast.classList.remove('show');
                }
            }, 2500);
        }

        function afterCopy() {
            // Call API to increment copy count
            if (pk) {
                fetch('/coordinates/' + pk + '/copy-coords/', { method: 'GET' })
                    .then(function (response) { return response.json(); })
                    .then(function (data) {
                        showSuccess(data.copy_count);
                    })
                    .catch(function () {
                        showSuccess();
                    });
            } else {
                showSuccess();
            }
        }

        // iOS Safari detection
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        if (isIOS || isSafari) {
            copyTextForiOS(coords, afterCopy);
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(coords).then(afterCopy).catch(function () {
                copyTextFallback(coords, afterCopy);
            });
        } else {
            copyTextFallback(coords, afterCopy);
        }
    }

    function copyTextForiOS(text, callback) {
        var input = document.createElement('input');
        input.setAttribute('readonly', 'readonly');
        input.setAttribute('contenteditable', 'true');
        input.style.position = 'fixed';
        input.style.top = '50%';
        input.style.left = '50%';
        input.style.opacity = '0';
        input.style.fontSize = '16px';
        input.value = text;
        document.body.appendChild(input);

        input.focus();
        input.setSelectionRange(0, text.length);

        var success = false;
        try {
            success = document.execCommand('copy');
        } catch (err) {
            success = false;
        }

        document.body.removeChild(input);

        if (success) {
            callback();
        } else {
            alert('ë³µì‚¬ë¨: ' + text);
        }
    }

    function copyTextFallback(text, callback) {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.style.top = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
            document.execCommand('copy');
            callback();
        } catch (err) {
            alert('ë³µì‚¬ë¨: ' + text);
        }

        document.body.removeChild(textarea);
    }

    // ë¬´í•œ ìŠ¤í¬ë¡¤
    (function () {
        var currentPage = 1;
        var isLoading = false;
        var hasNext = {% if has_next %}true{% else %} false{% endif %};
    var coordGrid = document.querySelector('.coord-grid');
    var sentinel = document.getElementById('scroll-sentinel');

    if (!sentinel || !coordGrid) return;

    var query = '{{ query|escapejs }}';
    var category = '{{ category|escapejs }}';
    var sort = '{{ sort|escapejs }}';
    var region = '{{ region_filter|escapejs }}';

    var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
            if (entry.isIntersecting && hasNext && !isLoading) {
                loadMore();
            }
        });
    }, { rootMargin: '100px' });

    observer.observe(sentinel);

    function loadMore() {
        isLoading = true;
        currentPage++;

        var url = '/coordinates/?page=' + currentPage;
        if (query) url += '&q=' + encodeURIComponent(query);
        if (category) url += '&category=' + encodeURIComponent(category);
        if (sort) url += '&sort=' + encodeURIComponent(sort);
        if (region) url += '&region=' + encodeURIComponent(region);

        fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(function (response) { return response.json(); })
            .then(function (data) {
                // ìƒˆ ì¹´ë“œ ì¶”ê°€
                var temp = document.createElement('div');
                temp.innerHTML = data.html;
                var newCards = temp.querySelectorAll('.coord-card');
                newCards.forEach(function (card) {
                    coordGrid.appendChild(card);
                    // ìƒˆ ì¹´ë“œì˜ ë³µì‚¬ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    var btn = card.querySelector('.copy-btn');
                    if (btn) {
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            var coords = this.getAttribute('data-coords');
                            if (coords) handleCopy(coords, this);
                        });
                        btn.addEventListener('touchend', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            var coords = this.getAttribute('data-coords');
                            if (coords) handleCopy(coords, this);
                        });
                    }
                });

                hasNext = data.has_next;
                isLoading = false;

                if (!hasNext) {
                    sentinel.classList.add('hidden');
                    observer.disconnect();
                }
            })
            .catch(function (err) {
                console.error('Failed to load more:', err);
                isLoading = false;
            });
    }
    }) ();
</script>
{% endblock %}