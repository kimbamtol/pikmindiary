{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "ì¢Œí‘œ ìˆ˜ì •" %} - {% trans "í”¼í¬ë¯¼ ë‹¤ì´ì–´ë¦¬" %}{% endblock %}

{% block content %}
<div class="container">
    <div class="form-page">
        <h1 class="page-title">âœï¸ {% trans "ì¢Œí‘œ ìˆ˜ì •" %}</h1>

        <form method="post" class="coord-form" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- ë¹„íšŒì› ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
            {% if not can_edit and coordinate.guest_password %}
            <div class="guest-notice">
                <p>ğŸ”’ {% trans "ë¹„íšŒì›ìœ¼ë¡œ ì‘ì„±ëœ ê¸€ì…ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." %}</p>
            </div>
            <div class="form-group">
                <label class="form-label">{% trans "ë¹„ë°€ë²ˆí˜¸" %} *</label>
                <input type="password" name="password" class="form-control" required>
            </div>
            {% endif %}

            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="form-group">
                <label class="form-label">{% trans "ì œëª©" %} *</label>
                <input type="text" name="title" class="form-control" value="{{ coordinate.title }}" required
                    maxlength="100">
            </div>

            <div class="form-group">
                <label class="form-label">{% trans "ì—½ì„œì´ë¦„" %}</label>
                <input type="text" name="postcard_name" class="form-control" value="{{ coordinate.postcard_name }}"
                    maxlength="100">
            </div>

            <div class="form-group">
                <label class="form-label">{% trans "ì¹´í…Œê³ ë¦¬" %} *</label>
                <select name="category" class="form-control" required>
                    {% for value, label in categories %}
                    <option value="{{ value }}" {% if coordinate.category == value %}selected{% endif %}>{{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- ì¢Œí‘œ ì…ë ¥ -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">{% trans "ìœ„ë„ (Latitude)" %} *</label>
                    <input type="text" name="latitude" id="latitude" class="form-control"
                        value="{{ coordinate.latitude }}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">{% trans "ê²½ë„ (Longitude)" %} *</label>
                    <input type="text" name="longitude" id="longitude" class="form-control"
                        value="{{ coordinate.longitude }}" required>
                </div>
            </div>

            <!-- ì„¤ëª… -->
            <div class="form-group">
                <label class="form-label">{% trans "ì„¤ëª…" %}</label>
                <textarea name="description" class="form-control" rows="4">{{ coordinate.description }}</textarea>
            </div>

            <!-- ê¸°ì¡´ ì´ë¯¸ì§€ -->
            {% if coordinate.images.all %}
            <div class="form-group">
                <label class="form-label">{% trans "í˜„ì¬ ì´ë¯¸ì§€" %}</label>
                <div class="existing-images">
                    {% for img in coordinate.images.all %}
                    <div class="existing-image-item">
                        <img src="{{ img.image.url }}" alt="ì´ë¯¸ì§€ {{ forloop.counter }}">
                        <label class="delete-checkbox">
                            <input type="checkbox" name="delete_images" value="{{ img.pk }}">
                            <span>{% trans "ì‚­ì œ" %}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <p class="form-hint">{% trans "ì‚­ì œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”" %}</p>
            </div>
            {% endif %}

            <!-- ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€ -->
            <div class="form-group">
                <label class="form-label">{% trans "ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€" %}</label>
                <input type="file" name="images" accept="image/*" multiple class="form-control">
                <p class="form-hint">{% trans "ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥ (ê¸°ì¡´ ì´ë¯¸ì§€ í¬í•¨)" %}</p>
            </div>

            <!-- ì›Œí„°ë§ˆí¬ ì˜µì…˜ -->
            <div class="form-group watermark-option">
                <label class="checkbox-label">
                    <input type="checkbox" name="watermark_enabled" id="watermark_enabled"
                           {% if coordinate.watermark_enabled %}checked{% endif %}
                           onchange="toggleWatermarkName()">
                    <span class="checkbox-text">ğŸ”’ {% trans "ì‚¬ì§„ì— ë‹‰ë„¤ì„ ì›Œí„°ë§ˆí¬ í‘œì‹œ" %}</span>
                </label>
                <small class="form-help">{% if coordinate.watermark_enabled %}{% trans "ì´ë¯¸ ì›Œí„°ë§ˆí¬ê°€ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤." %}{% else %}{% trans "ì²´í¬í•˜ë©´ ê¸°ì¡´ ì´ë¯¸ì§€ + ìƒˆ ì´ë¯¸ì§€ ëª¨ë‘ì— ì›Œí„°ë§ˆí¬ê°€ ì ìš©ë©ë‹ˆë‹¤. (í•œë²ˆ ì ìš©í•˜ë©´ ì·¨ì†Œ ë¶ˆê°€)" %}{% endif %}</small>

                <div id="watermark-name-field" class="watermark-name-field"
                     style="display: {% if coordinate.watermark_enabled %}block{% else %}none{% endif %};">
                    <label class="form-label">ì›Œí„°ë§ˆí¬ ë‹‰ë„¤ì„ (ì„ íƒ)</label>
                    <input type="text" name="watermark_name" class="form-control"
                           value="{{ coordinate.watermark_name }}"
                           placeholder="ë¹„ì›Œë‘ë©´ ì‘ì„±ì ë‹‰ë„¤ì„ ì‚¬ìš©" maxlength="50">
                    <small class="form-help">ì›Œí„°ë§ˆí¬ì— í‘œì‹œë  ì´ë¦„ì„ ì§ì ‘ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="form-actions">
                <a href="{% url 'coordinates:detail' pk=coordinate.pk %}" class="btn btn-outline">{% trans "ì·¨ì†Œ" %}</a>
                <button type="submit" class="btn btn-primary btn-lg">{% trans "ìˆ˜ì •í•˜ê¸°" %}</button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleWatermarkName() {
        const checkbox = document.getElementById('watermark_enabled');
        const nameField = document.getElementById('watermark-name-field');
        if (checkbox.checked) {
            nameField.style.display = 'block';
        } else {
            nameField.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const latInput = document.querySelector('input[name="latitude"]');
        const lngInput = document.querySelector('input[name="longitude"]');

        if (latInput && lngInput) {
            latInput.addEventListener('input', function (e) {
                const value = e.target.value;
                if (value.includes(',')) {
                    const parts = value.split(',');
                    if (parts.length === 2) {
                        const lat = parts[0].trim();
                        const lng = parts[1].trim();

                        latInput.value = lat;
                        lngInput.value = lng;

                        lngInput.focus();
                    }
                }
            });
        }
    });
</script>

<style>
    .form-page {
        max-width: 700px;
        margin: var(--spacing-xl) auto;
        padding: var(--spacing-xl);
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
    }

    .page-title {
        text-align: center;
        margin-bottom: var(--spacing-xl);
    }

    .guest-notice {
        padding: var(--spacing-md);
        background: #FFF3E0;
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
        color: #E65100;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
    }

    .form-group {
        margin-bottom: var(--spacing-lg);
    }

    .form-label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-weight: 600;
    }

    .existing-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: var(--spacing-md);
    }

    .existing-image-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--bg-tertiary);
    }

    .existing-image-item img {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
    }

    .delete-checkbox {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .existing-image-item:has(input:checked) {
        border-color: #dc3545;
        opacity: 0.6;
    }

    /* ì›Œí„°ë§ˆí¬ ì˜µì…˜ */
    .watermark-option {
        padding: var(--spacing-md);
        background: #E3F2FD;
        border-radius: var(--radius-md);
        border: 1px solid #90CAF9;
        margin-bottom: var(--spacing-lg);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .checkbox-text {
        font-weight: 600;
        color: var(--text-primary);
    }

    .watermark-name-field {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid #90CAF9;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-md);
    }

    @media (max-width: 480px) {
        .form-page {
            padding: var(--spacing-md);
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column-reverse;
        }
    }
</style>
{% endblock %}